<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园APP</title>
    <!-- 引入Vue.js和Axios -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入Element UI -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- 引入自定义样式 -->
    <link rel="stylesheet" href="/static/accounts/css/styles.css">
    

    <style>
        /* 添加v-cloak指令的CSS，防止闪现未编译的模板 */
        [v-cloak] {
            display: none;
        }
        
        /* APP布局样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            position: relative;
        }
        
        /* 顶部导航栏 */
        .top-bar {
            background-color: #409EFF;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 50px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .top-bar .title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            flex: 1;
        }
        
        .top-bar .action-btn {
            font-size: 20px;
            cursor: pointer;
            min-width: 40px;
            display: flex;
            justify-content: flex-end;
        }
        
        /* 内容区域 */
        .content-area {
            flex: 1;
            margin-top: 74px;
            margin-bottom: 60px;
            padding: 15px;
            overflow-y: auto;
            z-index: 10; /* 确保内容区域在导航栏之下 */
            position: relative;
            transition: opacity 0.3s ease;
        }
        
        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .nav-item {
            text-align: center;
            padding: 5px 0;
            width: 33.33%;
            cursor: pointer;
            color: #666;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .nav-item.active {
            color: #409EFF;
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 3px;
        }
        
        /* 学校选择器 */
        .school-selector {
            background-color: white;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* 卡片样式 */
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 论坛帖子 */
        .post-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            border-radius: 4px;
        }
        
        .post-item:hover {
            background-color: #ecf5ff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .post-item:last-child {
            border-bottom: none;
        }
        
        .post-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #303133;
        }
        
        .title-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .post-item:hover .title-text {
            color: #409EFF;
        }
        
        .post-title i {
            opacity: 0;
            transition: all 0.3s ease;
            margin-left: 5px;
        }
        
        .post-item:hover .post-title i {
            opacity: 1;
            transform: translateX(3px);
            color: #409EFF;
        }
        
        .post-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #909399;
        }
        
        /* 打卡项目 */
        .checkin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .checkin-item:last-child {
            border-bottom: none;
        }
        
        .checkin-info {
            flex: 1;
        }
        
        .checkin-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .checkin-time {
            font-size: 12px;
            color: #999;
        }
        
        /* 个人中心菜单 */
        .profile-menu {
            display: flex;
            flex-direction: column;
        }
        
        .menu-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            border-radius: 4px;
        }
        
        .menu-item:hover {
            background-color: #ecf5ff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item i.el-icon-arrow-right {
            opacity: 0;
            transition: all 0.3s ease;
            margin-left: 5px;
        }
        
        .menu-item:hover i.el-icon-arrow-right {
            opacity: 1;
            transform: translateX(3px);
            color: #409EFF;
        }
        
        body.dark-mode .menu-item:hover {
            background-color: #2a2a2a;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .menu-item:hover i.el-icon-arrow-right {
            color: #87CEFA;
        }
        
        .menu-item-left {
            display: flex;
            align-items: center;
            transition: color 0.3s ease;
        }
        
        .menu-item:hover .menu-item-left {
            color: #409EFF;
        }
        
        body.dark-mode .menu-item:hover .menu-item-left {
            color: #87CEFA;
        }
        
        .menu-icon {
            margin-right: 10px;
            color: #409EFF;
            font-size: 18px;
            transition: transform 0.3s ease, color 0.3s ease;
        }
        
        .menu-item:hover .menu-icon {
            transform: scale(1.2);
        }
        
        body.dark-mode .menu-icon {
            color: #87CEFA;
        }
        
        .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }
        
        .avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #409EFF;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .user-name {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .user-info {
            font-size: 12px;
            color: #999;
        }
        
        /* 调试区域样式 */
        #debug {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px;
            font-family: monospace;
            font-size: 12px;
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            z-index: 2000;
            display: none; /* 默认隐藏调试信息 */
        }
        #debug-log {
            max-height: 180px;
            overflow-y: auto;
        }
        #debug-log p {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        .task-section {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .task-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .task-title {
            font-weight: bold;
        }
        .task-info {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
        }
        .task-actions {
            margin-top: 8px;
        }
        /* 打卡社区样式 */
        .community-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .community-item:last-child {
            border-bottom: none;
        }
        
        .community-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .community-user {
            font-weight: bold;
            color: #409EFF;
        }
        
        .community-time {
            font-size: 12px;
            color: #999;
        }
        
        .community-content {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .community-task {
            font-weight: bold;
            color: #67C23A;
        }
        
        /* 任务项目样式 */
        .task-title {
            font-weight: bold;
        }
        
        .task-info {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
        }
        
        .task-actions {
            margin-top: 8px;
        }
        
        /* 夜间模式样式 */
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .card, .top-bar, .post-header, .post-content, .school-selector, .bottom-nav, 
        .el-dialog, .el-dropdown-menu, .el-button--default, .el-input__inner, .el-textarea__inner {
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        
        .card-title, .post-title, .user-name, .post-meta, .user-info, .checkin-time, .menu-item, 
        .checkin-item, .community-item, .task-item, .el-dropdown-menu__item, .el-dialog__title, .el-dialog__close {
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        
        body.dark-mode .top-bar {
            background-color: #1f1f1f;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .card,
        body.dark-mode .post-header,
        body.dark-mode .post-content,
        body.dark-mode .school-selector,
        body.dark-mode .bottom-nav {
            background-color: #1f1f1f;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .card-title,
        body.dark-mode .post-title,
        body.dark-mode .user-name {
            color: #e0e0e0;
        }
        
        body.dark-mode .post-meta,
        body.dark-mode .user-info,
        body.dark-mode .checkin-time {
            color: #aaaaaa;
        }
        
        body.dark-mode .post-item {
            border-bottom: 1px solid #333;
        }
        
        body.dark-mode .post-item:hover {
            background-color: #2a2a2a;
        }
        
        body.dark-mode .menu-item,
        body.dark-mode .checkin-item,
        body.dark-mode .community-item,
        body.dark-mode .task-item {
            border-bottom: 1px solid #333;
        }
        
        body.dark-mode .el-dropdown-menu {
            background-color: #1f1f1f;
            border-color: #333;
        }
        
        body.dark-mode .el-dropdown-menu__item {
            color: #e0e0e0;
        }
        
        body.dark-mode .el-dropdown-menu__item:hover {
            background-color: #2a2a2a;
            color: #409EFF;
        }
        
        body.dark-mode .el-dialog {
            background-color: #1f1f1f;
            border-color: #333;
        }
        
        body.dark-mode .el-dialog__title {
            color: #e0e0e0;
        }
        
        body.dark-mode .el-input__inner {
            background-color: #2a2a2a;
            border-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .el-textarea__inner {
            background-color: #2a2a2a;
            border-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .el-button--default {
            background-color: #2a2a2a;
            border-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .el-dialog__headerbtn .el-dialog__close {
            color: #e0e0e0;
        }
        
        /* 内容过渡效果 */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s;
        }
        .fade-enter, .fade-leave-to {
            opacity: 0;
        }
        
        /* 加载遮罩层 */
        .loading-overlay {
            position: fixed;
            top: 74px;
            bottom: 60px;
            left: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            transition: opacity 0.3s ease;
        }
        
        body.dark-mode .loading-overlay {
            background-color: rgba(31, 31, 31, 0.8);
        }
        
        body.dark-mode .loading-overlay p {
            color: #e0e0e0;
                    }
            
            /* 专注模式样式 */
            .focus-stats {
                display: flex;
                justify-content: space-around;
                padding: 20px 0;
                margin-bottom: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 12px;
                color: white;
            }
            
            .stat-item {
                text-align: center;
            }
            
            .stat-number {
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 4px;
            }
            
            .stat-label {
                font-size: 12px;
                opacity: 0.8;
            }
            
            .focus-session-container {
                padding: 40px 20px;
                text-align: center;
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                border-radius: 20px;
                color: white;
                min-height: 60vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            .focus-header h2 {
                font-size: 28px;
                margin-bottom: 10px;
                color: white;
            }
            
            .focus-header p {
                font-size: 16px;
                opacity: 0.9;
                margin-bottom: 40px;
            }
            
            .focus-timer {
                margin: 40px 0;
            }
            
            .timer-circle {
                width: 200px;
                height: 200px;
                border: 8px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                margin: 0 auto;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }
            
            .timer-display {
                font-size: 48px;
                font-weight: bold;
                font-family: 'Courier New', monospace;
                margin-bottom: 8px;
            }
            
            .timer-type {
                font-size: 14px;
                opacity: 0.8;
            }
            
            .focus-controls {
                display: flex;
                gap: 15px;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .focus-controls .el-button {
                border: 2px solid rgba(255, 255, 255, 0.3);
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                color: white;
                font-weight: bold;
                min-width: 100px;
            }
            
            .focus-controls .el-button:hover {
                background: rgba(255, 255, 255, 0.2);
                border-color: rgba(255, 255, 255, 0.5);
            }
            
            .focus-history-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .history-main {
                flex: 1;
            }
            
            .history-title {
                font-weight: 500;
                margin-bottom: 4px;
            }
            
            .history-time {
                font-size: 12px;
                color: #999;
            }
            
            .history-status {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 4px;
            }
            
            .history-duration {
                font-size: 12px;
                color: #666;
            }
        </style>
</head>
<body>
    <!-- 添加v-cloak指令，防止Vue模板闪现 -->
    <div id="app" v-cloak>
        <div class="app-container">
            <!-- 顶部导航栏 -->
            <div class="top-bar">
                <!-- 左侧区域 -->
                <div class="action-btn" v-if="currentTab === 'forum'">
                    <i class="el-icon-location"></i>
                    <el-dropdown @command="changeSchool" trigger="click">
                        <span class="title">{{ selectedSchool.name }} <i class="el-icon-arrow-down el-icon--right"></i></span>
                        <el-dropdown-menu slot="dropdown">
                            <el-dropdown-item v-for="school in schools" :key="school.id" :command="school.id">
                                {{ school.name }}
                            </el-dropdown-item>
                        </el-dropdown-menu>
                    </el-dropdown>
                </div>
                <div v-else style="width: 20px;"></div>
                
                <!-- 中间标题区域 -->
                <div class="title" v-if="currentTab === 'profile'">个人中心</div>
                <div class="title" v-else-if="currentTab === 'checkin'">打卡</div>
                <div class="title" v-else-if="currentTab === 'tasks'">打卡动态</div>
                <div class="title" v-else-if="currentTab === 'focus'">专注模式</div>
                <div class="title" v-else-if="currentTab === 'forum'"></div>
                
                <!-- 右侧按钮区域 -->
                <div class="action-btn" v-if="currentTab === 'forum'">
                    <i class="el-icon-chat-line-square" @click="enterChatRoom"></i>
                </div>
                <div class="action-btn" v-else-if="currentTab === 'checkin'">
                    <i class="el-icon-plus" @click="dialogVisible = true; dialogType = 'task'; dialogTitle = '创建新任务'"></i>
                </div>
                <div class="action-btn" v-else-if="currentTab === 'tasks'">
                    <i class="el-icon-refresh" @click="refreshCommunity"></i>
                </div>
                <div class="action-btn" v-else-if="currentTab === 'focus' && !focusMode.inSession">
                    <i class="el-icon-setting" @click="showFocusSettings"></i>
                </div>
                <div v-else style="width: 20px;"></div>
            </div>
            
            <!-- 内容区域 -->
            <div class="content-area">
                <!-- 首页欢迎板块 -->
                <div class="card" id="static-card" v-if="!initialized">
                    <div class="card-title">欢迎访问校园APP</div>
                    <div style="padding: 15px;">
                        <p>页面加载中，请稍候...</p>
                    </div>
                </div>
                
                <!-- 加载遮罩层 -->
                <transition name="fade">
                    <div v-if="loading" class="loading-overlay">
                        <div style="text-align: center;">
                            <i class="el-icon-loading" style="font-size: 30px; color: #409EFF;"></i>
                            <p style="margin-top: 10px; color: #606266;">加载中...</p>
                        </div>
                    </div>
                </transition>
                
                <!-- 调试信息 -->
                <div class="card" v-if="false">
                    <div class="card-title">加载中...</div>
                </div>
                
                <!-- 各模块内容 -->
                <div v-show="!loading">
                    <!-- 论坛板块 -->
                    <div v-if="currentTab === 'forum'">
                        <div class="card">
                            <div class="card-title">
                                热门帖子
                                <el-button v-if="isLoggedIn" type="text" size="mini" @click="dialogVisible = true; dialogType = 'post'; dialogTitle = '创建新帖子'">
                                    发布帖子
                                </el-button>
                            </div>
                            <div class="post-item" v-for="post in filteredPosts" :key="post.id" @click="viewPostDetail(post)">
                                <div class="post-title">
                                    <span class="title-text">{{ post.title }}</span>
                                    <i class="el-icon-arrow-right" style="font-size: 14px; color: #909399;"></i>
                                </div>
                                <div class="post-meta">
                                    <span><i class="el-icon-user" style="margin-right: 4px;"></i>{{ post.author }}</span>
                                    <span><i class="el-icon-time" style="margin-right: 4px;"></i>{{ post.time }}</span>
                                </div>
                            </div>
                            <div v-if="filteredPosts.length === 0" style="text-align: center; padding: 20px 0; color: #999;">
                                暂无帖子
                            </div>
                        </div>
                        
                        <!-- 用户自己发布的帖子 (包括待审核的) -->
                        <div class="card" v-if="userPosts.length > 0">
                            <div class="card-title">
                                我的帖子
                            </div>
                            <div class="post-item" v-for="post in userPosts" :key="post.id" @click="viewPostDetail(post)">
                                <div class="post-title">
                                    <span class="title-text">{{ post.title }}</span>
                                    <el-tag size="mini" :type="getStatusType(post.status)" style="margin-left: 10px;">
                                        {{ post.status_display }}
                                    </el-tag>
                                </div>
                                <div class="post-meta">
                                    <span><i class="el-icon-user" style="margin-right: 4px;"></i>{{ post.author }}</span>
                                    <span><i class="el-icon-time" style="margin-right: 4px;"></i>{{ post.time }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 打卡板块 -->
                    <div v-if="currentTab === 'checkin'">
                        <div class="card">
                            <div class="card-title">
                                打卡任务
                                <el-button type="text" size="mini" @click="dialogVisible = true; dialogType = 'task'; dialogTitle = '创建新任务'">
                                    创建任务
                                </el-button>
                            </div>
                            <div class="task-item" v-for="checkin in filteredCheckins" :key="checkin.id">
                                <div class="task-title">{{ checkin.title }}</div>
                                <div class="task-info" v-if="checkin.time">时间要求: {{ checkin.time }}</div>
                                <div class="task-info" v-if="checkin.description">{{ checkin.description }}</div>
                                <div class="task-info" v-if="checkin.created_at">创建于: {{ checkin.created_at }}</div>
                                <div class="task-actions">
                                    <el-button 
                                        size="mini" 
                                        type="success" 
                                        :disabled="checkin.checked_today" 
                                        @click="doCheckin(checkin)">
                                        {{ checkin.checked_today ? '今日已打卡' : '打卡' }}
                                    </el-button>
                                    <el-button 
                                        size="mini" 
                                        type="danger" 
                                        v-if="checkin.is_creator"
                                        @click="deleteCheckin(checkin)">
                                        删除
                                    </el-button>
                                </div>
                            </div>
                            <div v-if="filteredCheckins.length === 0" style="text-align: center; padding: 20px 0; color: #999;">
                                暂无打卡任务，创建一个新任务吧！
                            </div>
                        </div>
                    </div>
                    
                    <!-- 打卡社区板块 -->
                    <div v-if="currentTab === 'tasks'">
                        <div class="card">
                            <div class="card-title">
                                打卡动态
                                <el-button type="text" size="mini" @click="refreshCommunity">刷新</el-button>
                            </div>
                            <div v-if="communityCheckins.length === 0" style="text-align: center; padding: 20px 0; color: #999;">
                                暂无打卡动态
                            </div>
                            <div class="community-item" v-for="record in communityCheckins" :key="record.id">
                                <div class="community-header">
                                    <span class="community-user">{{ record.username }}</span>
                                    <span class="community-time">{{ record.checked_at }}</span>
                                </div>
                                <div class="community-content">
                                    打卡了 <span class="community-task">{{ record.checkin_title }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 专注模式板块 -->
                    <div v-if="currentTab === 'focus'">
                        <!-- 非专注状态 - 显示开始界面 -->
                        <div v-if="!focusMode.inSession">
                            <div class="card">
                                <div class="card-title">
                                    🎯 专注模式
                                    <el-button type="text" size="mini" @click="showFocusSettings">设置</el-button>
                                </div>
                                
                                <!-- 今日统计 -->
                                <div class="focus-stats">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ focusMode.stats.today.completed_sessions || 0 }}</div>
                                        <div class="stat-label">今日完成</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">{{ formatDuration(focusMode.stats.today.total_minutes || 0) }}</div>
                                        <div class="stat-label">今日时长</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">{{ focusMode.stats.total.completed_sessions || 0 }}</div>
                                        <div class="stat-label">总完成</div>
                                    </div>
                                </div>
                                
                                <!-- 开始专注按钮 -->
                                <div class="focus-start-section">
                                    <el-button 
                                        type="primary" 
                                        size="large" 
                                        round
                                        @click="showStartFocusDialog"
                                        style="width: 100%; height: 60px; font-size: 18px; margin-top: 20px;">
                                        <i class="el-icon-timer" style="margin-right: 8px;"></i>
                                        开始专注
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- 历史记录 -->
                            <div class="card" v-if="focusHistory.length > 0">
                                <div class="card-title">
                                    📊 最近记录
                                    <el-button type="text" size="mini" @click="showAllHistory">查看全部</el-button>
                                </div>
                                <div class="focus-history-item" v-for="session in focusHistory.slice(0, 5)" :key="session.id">
                                    <div class="history-main">
                                        <div class="history-title">{{ session.task_title }}</div>
                                        <div class="history-time">{{ session.start_time }}</div>
                                    </div>
                                    <div class="history-status">
                                        <el-tag 
                                            size="mini" 
                                            :type="session.completed ? 'success' : (session.interrupted ? 'danger' : 'info')">
                                            {{ session.completed ? '完成' : (session.interrupted ? '中断' : '进行中') }}
                                        </el-tag>
                                        <div class="history-duration">{{ session.actual_duration || session.planned_duration }}分钟</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 专注状态 - 显示计时器 -->
                        <div v-else class="focus-session-container">
                            <div class="focus-header">
                                <h2>{{ focusMode.currentSession.task_title }}</h2>
                                <p v-if="focusMode.currentSession.task_description">{{ focusMode.currentSession.task_description }}</p>
                            </div>
                            
                            <div class="focus-timer">
                                <div class="timer-circle">
                                    <div class="timer-display">
                                        {{ formatTime(focusMode.timer.remaining) }}
                                    </div>
                                    <div class="timer-type">
                                        {{ focusMode.currentSession.session_type === 'work' ? '专注时间' : '休息时间' }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="focus-controls">
                                <el-button 
                                    v-if="!focusMode.timer.isRunning" 
                                    type="success" 
                                    size="large" 
                                    round
                                    @click="startTimer">
                                    <i class="el-icon-video-play"></i> 开始
                                </el-button>
                                <el-button 
                                    v-else-if="!focusMode.timer.isPaused" 
                                    type="warning" 
                                    size="large" 
                                    round
                                    @click="pauseTimer">
                                    <i class="el-icon-video-pause"></i> 暂停
                                </el-button>
                                <el-button 
                                    v-else 
                                    type="success" 
                                    size="large" 
                                    round
                                    @click="resumeTimer">
                                    <i class="el-icon-video-play"></i> 继续
                                </el-button>
                                <el-button 
                                    type="danger" 
                                    size="large" 
                                    round
                                    @click="stopSession">
                                    <i class="el-icon-close"></i> 结束
                                </el-button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 个人中心板块 -->
                    <div v-if="currentTab === 'profile'">
                        <div class="card">
                            <div class="avatar-container">
                                <div class="avatar">{{ avatarInitial }}</div>
                                <div class="user-name">{{ displayUsername }}</div>
                                <div class="user-info">{{ userInfo.email }}</div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="profile-menu">
                                <div class="menu-item" @click="showProfile">
                                    <div class="menu-item-left">
                                        <i class="el-icon-user menu-icon"></i>
                                        <span>个人资料</span>
                                    </div>
                                    <i class="el-icon-arrow-right"></i>
                                </div>
                                <div class="menu-item" @click="showSettings">
                                    <div class="menu-item-left">
                                        <i class="el-icon-setting menu-icon"></i>
                                        <span>设置</span>
                                    </div>
                                    <i class="el-icon-arrow-right"></i>
                                </div>
                                <div class="menu-item" @click="showSecurity">
                                    <div class="menu-item-left">
                                        <i class="el-icon-lock menu-icon"></i>
                                        <span>安全中心</span>
                                    </div>
                                    <i class="el-icon-arrow-right"></i>
                                </div>
                                <div v-if="userInfo.is_staff" class="menu-item" @click="goToAdminPage">
                                    <div class="menu-item-left">
                                        <i class="el-icon-key menu-icon"></i>
                                        <span>管理员后台</span>
                                    </div>
                                    <i class="el-icon-arrow-right"></i>
                                </div>
                                <div class="menu-item" @click="logout">
                                    <div class="menu-item-left">
                                        <i class="el-icon-switch-button menu-icon" style="color: #F56C6C;"></i>
                                        <span style="color: #F56C6C;">退出登录</span>
                                    </div>
                                    <i class="el-icon-arrow-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 底部导航 -->
            <div class="bottom-nav">
                <div 
                    class="nav-item" 
                    :class="{ active: currentTab === 'forum' }" 
                    @click="currentTab = 'forum'">
                    <i class="nav-icon el-icon-chat-line-square"></i>
                    <span>论坛</span>
                </div>
                <div 
                    class="nav-item" 
                    :class="{ active: currentTab === 'checkin' }" 
                    @click="currentTab = 'checkin'">
                    <i class="nav-icon el-icon-date"></i>
                    <span>打卡</span>
                </div>
                <div 
                    class="nav-item" 
                    :class="{ active: currentTab === 'tasks' }" 
                    @click="currentTab = 'tasks'">
                    <i class="nav-icon el-icon-s-data"></i>
                    <span>动态</span>
                </div>
                <div 
                    class="nav-item" 
                    :class="{ active: currentTab === 'focus' }" 
                    @click="currentTab = 'focus'">
                    <i class="nav-icon el-icon-timer"></i>
                    <span>专注</span>
                </div>
                <div 
                    class="nav-item" 
                    :class="{ active: currentTab === 'profile' }" 
                    @click="currentTab = 'profile'">
                    <i class="nav-icon el-icon-user"></i>
                    <span>我的</span>
                </div>
            </div>
            
            <!-- 对话框 -->
            <el-dialog 
                :title="dialogTitle" 
                :visible.sync="dialogVisible"
                width="90%">
                <div v-if="dialogType === 'profile'">
                    <el-form label-width="80px">
                        <el-form-item label="用户名">
                            <el-input v-model="userInfo.username" disabled></el-input>
                        </el-form-item>
                        <el-form-item label="邮箱">
                            <el-input v-model="userInfo.email" disabled></el-input>
                        </el-form-item>
                        <el-form-item label="手机号" v-if="userInfo.phone">
                            <el-input v-model="userInfo.phone" disabled></el-input>
                        </el-form-item>
                    </el-form>
                </div>
                <div v-else-if="dialogType === 'security'">
                    <div style="padding: 10px 0;">
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-message menu-icon"></i>
                                <div>
                                    <div>邮箱绑定</div>
                                    <div style="font-size: 12px; color: #999;">{{ userInfo.email || '未绑定' }}</div>
                                </div>
                            </div>
                            <el-button size="mini" type="text" @click="changeEmail">{{ userInfo.email ? '更换' : '绑定' }}</el-button>
                        </div>
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-mobile-phone menu-icon"></i>
                                <div>
                                    <div>手机绑定</div>
                                    <div style="font-size: 12px; color: #999;">{{ userInfo.phone || '未绑定' }}</div>
                                </div>
                            </div>
                            <el-button size="mini" type="text">{{ userInfo.phone ? '更换' : '绑定' }}</el-button>
                        </div>
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-key menu-icon"></i>
                                <div>修改密码</div>
                            </div>
                            <el-button size="mini" type="text">修改</el-button>
                        </div>
                    </div>
                </div>
                <div v-else-if="dialogType === 'settings'">
                    <div style="padding: 10px 0;">
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-bell menu-icon"></i>
                                <span>消息通知</span>
                            </div>
                            <el-switch v-model="settings.notifications"></el-switch>
                        </div>
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-moon menu-icon"></i>
                                <span>深色模式</span>
                            </div>
                            <el-switch v-model="settings.darkMode" @change="toggleDarkMode"></el-switch>
                        </div>
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-document menu-icon"></i>
                                <span>隐私政策</span>
                            </div>
                            <i class="el-icon-arrow-right"></i>
                        </div>
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-question menu-icon"></i>
                                <span>关于我们</span>
                            </div>
                            <i class="el-icon-arrow-right"></i>
                        </div>
                    </div>
                </div>
                <div v-else-if="dialogType === 'task'">
                    <el-form :model="newTask" label-width="80px">
                        <el-form-item label="任务名称" required>
                            <el-input v-model="newTask.title" placeholder="请输入任务名称"></el-input>
                        </el-form-item>
                        <el-form-item label="时间要求">
                            <el-input v-model="newTask.time" placeholder="如：每天早上8点"></el-input>
                        </el-form-item>
                        <el-form-item label="任务描述">
                            <el-input 
                                type="textarea" 
                                v-model="newTask.description" 
                                placeholder="请输入任务描述"
                                :rows="3"></el-input>
                        </el-form-item>
                    </el-form>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="dialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="createTask">创 建</el-button>
                    </span>
                </div>
                <div v-else-if="dialogType === 'changeEmail'">
                    <el-form :model="emailForm" label-width="80px">
                        <el-form-item label="原邮箱" required>
                            <el-input v-model="userInfo.email" disabled></el-input>
                        </el-form-item>
                        <el-form-item label="验证码" required>
                            <div style="display: flex;">
                                <el-input v-model="emailForm.oldCode" placeholder="请输入验证码"></el-input>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    style="margin-left: 10px; width: 120px;" 
                                    :disabled="oldCodeSending"
                                    @click="sendOldEmailCode">
                                    {{ oldCodeSending ? `${oldCodeTimer}s` : '获取验证码' }}
                                </el-button>
                            </div>
                        </el-form-item>
                        <el-form-item label="新邮箱" required>
                            <el-input v-model="emailForm.newEmail" placeholder="请输入新邮箱"></el-input>
                        </el-form-item>
                        <el-form-item label="验证码" required>
                            <div style="display: flex;">
                                <el-input v-model="emailForm.newCode" placeholder="请输入验证码"></el-input>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    style="margin-left: 10px; width: 120px;" 
                                    :disabled="newCodeSending || !emailForm.newEmail"
                                    @click="sendNewEmailCode">
                                    {{ newCodeSending ? `${newCodeTimer}s` : '获取验证码' }}
                                </el-button>
                            </div>
                        </el-form-item>
                    </el-form>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="dialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="updateEmail">确 认</el-button>
                    </span>
                </div>
                <div v-else-if="dialogType === 'post'">
                    <el-form :model="newPost" label-width="80px">
                        <el-form-item label="标题" required>
                            <el-input v-model="newPost.title" placeholder="请输入帖子标题"></el-input>
                        </el-form-item>
                        <el-form-item label="内容" required>
                            <el-input 
                                type="textarea" 
                                v-model="newPost.content" 
                                placeholder="请输入帖子内容"
                                :rows="5"></el-input>
                        </el-form-item>
                    </el-form>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="dialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="createPost">发 布</el-button>
                    </span>
                </div>
                <div v-else-if="dialogType === 'startFocus'">
                    <el-form :model="focusTaskForm" label-width="80px">
                        <el-form-item label="任务标题" required>
                            <el-input v-model="focusTaskForm.title" placeholder="请输入要专注的任务"></el-input>
                        </el-form-item>
                        <el-form-item label="任务描述">
                            <el-input 
                                type="textarea" 
                                v-model="focusTaskForm.description" 
                                placeholder="任务的详细描述（可选）"
                                :rows="3"></el-input>
                        </el-form-item>
                        <el-form-item label="专注时长">
                            <el-select v-model="focusTaskForm.duration" style="width: 100%;">
                                <el-option label="15分钟" :value="15"></el-option>
                                <el-option label="25分钟 (推荐)" :value="25"></el-option>
                                <el-option label="30分钟" :value="30"></el-option>
                                <el-option label="45分钟" :value="45"></el-option>
                                <el-option label="60分钟" :value="60"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-form>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="dialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="startFocusSession">开始专注</el-button>
                    </span>
                </div>
                <div v-else-if="dialogType === 'focusSettings'">
                    <el-form :model="focusMode.settings" label-width="120px">
                        <el-form-item label="工作时长">
                            <el-input-number 
                                v-model="focusMode.settings.work_duration" 
                                :min="5" 
                                :max="120" 
                                style="width: 100%;"
                                controls-position="right">
                            </el-input-number>
                            <span style="color: #999; font-size: 12px;">分钟</span>
                        </el-form-item>
                        <el-form-item label="短休息时长">
                            <el-input-number 
                                v-model="focusMode.settings.break_duration" 
                                :min="1" 
                                :max="30" 
                                style="width: 100%;"
                                controls-position="right">
                            </el-input-number>
                            <span style="color: #999; font-size: 12px;">分钟</span>
                        </el-form-item>
                        <el-form-item label="长休息时长">
                            <el-input-number 
                                v-model="focusMode.settings.long_break_duration" 
                                :min="5" 
                                :max="60" 
                                style="width: 100%;"
                                controls-position="right">
                            </el-input-number>
                            <span style="color: #999; font-size: 12px;">分钟</span>
                        </el-form-item>
                        <el-form-item label="长休息间隔">
                            <el-input-number 
                                v-model="focusMode.settings.sessions_before_long_break" 
                                :min="2" 
                                :max="8" 
                                style="width: 100%;"
                                controls-position="right">
                            </el-input-number>
                            <span style="color: #999; font-size: 12px;">个专注会话后</span>
                        </el-form-item>
                        <el-form-item label="声音提醒">
                            <el-switch v-model="focusMode.settings.sound_enabled"></el-switch>
                        </el-form-item>
                        <el-form-item label="自动开始休息">
                            <el-switch v-model="focusMode.settings.auto_start_breaks"></el-switch>
                        </el-form-item>
                        <el-form-item label="自动开始工作">
                            <el-switch v-model="focusMode.settings.auto_start_work"></el-switch>
                        </el-form-item>
                    </el-form>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="dialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="updateFocusSettings">保 存</el-button>
                    </span>
                </div>
                <div v-else-if="dialogType === 'focusHistory'">
                    <div style="max-height: 400px; overflow-y: auto;">
                        <div class="focus-history-item" v-for="session in focusHistory" :key="session.id">
                            <div class="history-main">
                                <div class="history-title">{{ session.task_title }}</div>
                                <div class="history-time">{{ session.start_time }}</div>
                                <div v-if="session.task_description" style="font-size: 12px; color: #999; margin-top: 4px;">
                                    {{ session.task_description }}
                                </div>
                            </div>
                            <div class="history-status">
                                <el-tag 
                                    size="mini" 
                                    :type="session.completed ? 'success' : (session.interrupted ? 'danger' : 'info')">
                                    {{ session.completed ? '完成' : (session.interrupted ? '中断' : '进行中') }}
                                </el-tag>
                                <div class="history-duration">
                                    计划: {{ session.planned_duration }}分钟
                                </div>
                                <div class="history-duration" v-if="session.actual_duration">
                                    实际: {{ session.actual_duration }}分钟
                                </div>
                            </div>
                        </div>
                        <div v-if="focusHistory.length === 0" style="text-align: center; padding: 40px 0; color: #999;">
                            暂无专注记录
                        </div>
                    </div>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="dialogVisible = false">关 闭</el-button>
                    </span>
                </div>
            </el-dialog>
        </div>
    </div>

    <!-- 整合的JavaScript脚本 -->
    <script>
        // 添加调试功能
        console.originalLog = console.log;
        console.log = function() {
            console.originalLog.apply(console, arguments);
            var message = Array.prototype.slice.call(arguments).join(' ');
            var debugLog = document.getElementById('debug-log');
            if (debugLog) {
                var p = document.createElement('p');
                p.textContent = message;
                debugLog.appendChild(p);
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        };
        
        // 确保静态内容显示，直到Vue加载完成
        var staticContent = document.getElementById('static-content');
        if (staticContent) {
            staticContent.style.display = 'block';
        }
        
        // DOMContentLoaded事件后初始化Vue
        document.addEventListener('DOMContentLoaded', function() {
            // 创建Vue实例
            window.vueApp = new Vue({
                el: '#app',
                data: {
                    initialized: false,
                    loading: false,
                    isLoggedIn: false,
                    userInfo: { username: '游客用户', email: '未登录' },
                    currentTab: 'checkin',
                    selectedSchool: { id: null, name: '请选择学校' },
                    schools: [],
                    dialogVisible: false,
                    dialogType: '',
                    dialogTitle: '',
                    settings: {
                        notifications: true,
                        darkMode: false
                    },
                    posts: [],
                    checkins: [],
                    communityCheckins: [],
                    activeTab: 'tasks',
                    newTask: {
                        title: '',
                        time: '',
                        description: ''
                    },
                    emailForm: {
                        oldCode: '',
                        newEmail: '',
                        newCode: ''
                    },
                    oldCodeSending: false,
                    oldCodeTimer: 60,
                    newCodeSending: false,
                    newCodeTimer: 60,
                    newPost: {
                        title: '',
                        content: ''
                    },
                    userPosts: [],
                    // 专注模式相关数据
                    focusMode: {
                        enabled: false,
                        inSession: false,
                        currentSession: null,
                        timer: {
                            duration: 0,
                            remaining: 0,
                            isRunning: false,
                            isPaused: false
                        },
                        settings: {
                            work_duration: 25,
                            break_duration: 5,
                            long_break_duration: 15,
                            sessions_before_long_break: 4,
                            sound_enabled: true,
                            auto_start_breaks: false,
                            auto_start_work: false,
                            focus_theme: 'default'
                        },
                        stats: {
                            today: { sessions_count: 0, completed_sessions: 0, total_minutes: 0 },
                            week: { sessions_count: 0, completed_sessions: 0, total_minutes: 0 },
                            month: { sessions_count: 0, completed_sessions: 0, total_minutes: 0 },
                            total: { sessions_count: 0, completed_sessions: 0, total_minutes: 0 }
                        }
                    },
                    focusTaskForm: {
                        title: '',
                        description: '',
                        duration: 25
                    },
                    timerInterval: null,
                    focusHistory: []
                },
                computed: {
                    avatarInitial() {
                        return this.userInfo.username ? this.userInfo.username[0].toUpperCase() : '?';
                    },
                    displayUsername() {
                        return this.userInfo.username || '用户';
                    },
                    filteredPosts() {
                        // 后端API已经按学校过滤，无需再次过滤
                        return this.posts;
                    },
                    filteredCheckins() {
                        // 后端API已经按学校过滤，无需再次过滤
                        return this.checkins;
                    }
                },
                watch: {
                    currentTab(newTab, oldTab) {
                        // 先显示加载状态
                        this.loading = true;
                        
                        // 当切换到论坛标签时，加载论坛数据
                        if (newTab === 'forum' && this.selectedSchool.id) {
                            this.fetchForumData();
                        }
                        // 当切换到打卡标签时，加载打卡数据
                        else if (newTab === 'checkin') {
                            this.refreshCheckins();
                        }
                        // 当切换到动态标签时，加载动态数据
                        else if (newTab === 'tasks') {
                            this.refreshCommunity();
                        } else {
                            // 如果是其他标签（如个人中心），直接关闭加载状态，但添加短暂延迟
                            setTimeout(() => {
                                this.loading = false;
                            }, 200);
                        }
                    }
                },
                methods: {
                    fetchSchools() {
                        this.loading = true;
                        axios.get('/forum/api/schools/')
                            .then(response => {
                                this.schools = response.data;
                                if (this.schools.length > 0 && !this.selectedSchool.id) {
                                    this.selectedSchool = this.schools[0];
                                }
                                this.loading = false;
                                // 获取初始学校的数据
                                this.fetchSchoolData();
                            })
                            .catch(error => {
                                console.error('获取学校列表失败:', error);
                                this.loading = false;
                                this.$message.error('获取学校数据失败，请刷新页面重试');
                            });
                    },
                    fetchSchoolData() {
                        if (!this.selectedSchool.id) return;
                        
                        this.loading = true;
                        // 根据当前标签加载相应数据
                        if (this.currentTab === 'forum') {
                            this.fetchForumData();
                        } else {
                            // 并行请求打卡和社区数据
                            Promise.all([
                                axios.get(`/checkin/checkins/`),
                                axios.get('/checkin/community/')
                            ])
                            .then(([checkinsResponse, communityResponse]) => {
                                this.checkins = checkinsResponse.data;
                                this.communityCheckins = communityResponse.data;
                                this.loading = false;
                            })
                            .catch(error => {
                                console.error('获取数据失败:', error);
                                this.loading = false;
                                this.$message.error('获取数据失败，请刷新页面重试');
                            });
                        }
                    },
                    changeSchool(schoolId) {
                        const school = this.schools.find(s => s.id === schoolId);
                        if (school) {
                            this.selectedSchool = school;
                            // 切换学校后重新获取论坛数据
                            if (this.currentTab === 'forum') {
                                this.fetchForumData();
                            }
                        }
                    },
                    showProfile() {
                        this.dialogType = 'profile';
                        this.dialogTitle = '个人资料';
                        this.dialogVisible = true;
                    },
                    changeEmail() {
                        this.dialogType = 'changeEmail';
                        this.dialogTitle = '更换邮箱';
                        this.dialogVisible = true;
                    },
                    showSecurity() {
                        this.dialogType = 'security';
                        this.dialogTitle = '安全中心';
                        this.dialogVisible = true;
                    },
                    showSettings() {
                        this.dialogType = 'settings';
                        this.dialogTitle = '设置';
                        this.dialogVisible = true;
                    },
                    logout() {
                        localStorage.removeItem('user');
                        localStorage.removeItem('token');
                        delete axios.defaults.headers.common['Authorization'];
                        this.$message.success('已退出登录');
                        setTimeout(() => { window.location.href = '/accounts/auth/'; }, 500);
                    },
                    doCheckin(checkin) {
                        this.loading = true;
                        // 调用后端API进行打卡
                        axios.post(`/checkin/checkins/${checkin.id}/check/`)
                            .then(response => {
                                // 更新本地打卡状态
                                const index = this.checkins.findIndex(c => c.id === checkin.id);
                                if (index !== -1) {
                                    this.checkins[index].checked_today = true;
                                    // 确保返回的数据包含checkin_record，并安全获取ID
                                    const checkinRecord = response.data.checkin_record || {};
                                    this.checkins[index].today_checkin_id = checkinRecord.id;
                                    this.$message.success('打卡成功！');
                                }
                                
                                // 刷新社区动态
                                this.refreshCommunity();
                                
                                this.loading = false;
                            })
                            .catch(error => {
                                console.error('打卡失败:', error);
                                this.loading = false;
                                this.$message.error('操作失败，请重试');
                            });
                    },
                    refreshCheckins() {
                        // 重新获取打卡数据
                        this.loading = true;
                        axios.get(`/checkin/checkins/`)
                            .then(response => {
                                this.checkins = response.data;
                                setTimeout(() => {
                                    this.loading = false;
                                }, 200); // 添加短暂延迟，确保动画平滑
                                this.$message.success('已刷新打卡列表');
                            })
                            .catch(error => {
                                console.error('刷新打卡列表失败:', error);
                                this.loading = false;
                                this.$message.error('刷新失败，请重试');
                            });
                    },
                    checkLoginStatus() {
                        const token = localStorage.getItem('token');
                        const user = localStorage.getItem('user');
                        
                        if (token && user) {
                            try {
                                this.userInfo = JSON.parse(user);
                                this.isLoggedIn = true;
                                
                                // 设置Authorization头
                                axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                                
                                // 另外在每个请求中添加X-Auth-Token，确保在某些环境能被正确拦截
                                axios.interceptors.request.use(config => {
                                    config.headers['X-Auth-Token'] = token;
                                    return config;
                                });
                                
                            } catch (e) {
                                console.error('解析用户信息失败:', e);
                                this.isLoggedIn = false;
                            }
                        } else {
                            this.isLoggedIn = false;
                            this.userInfo = { username: '游客用户', email: '未登录' };
                        }
                    },
                    // ===== 专注模式相关方法 =====
                    loadFocusData() {
                        this.loadFocusSettings();
                        this.loadFocusStats();
                        this.loadFocusHistory();
                        this.checkActiveSession();
                    },
                    loadFocusSettings() {
                        axios.get('/focus/settings/')
                            .then(response => {
                                if (response.data.success) {
                                    this.focusMode.settings = response.data.settings;
                                }
                            })
                            .catch(error => {
                                console.error('获取专注设置失败:', error);
                            });
                    },
                    loadFocusStats() {
                        axios.get('/focus/stats/')
                            .then(response => {
                                if (response.data.success) {
                                    this.focusMode.stats = response.data.stats;
                                }
                            })
                            .catch(error => {
                                console.error('获取专注统计失败:', error);
                            });
                    },
                    loadFocusHistory() {
                        axios.get('/focus/history/')
                            .then(response => {
                                if (response.data.success) {
                                    this.focusHistory = response.data.sessions;
                                }
                            })
                            .catch(error => {
                                console.error('获取专注历史失败:', error);
                            });
                    },
                    checkActiveSession() {
                        axios.get('/focus/session/active/')
                            .then(response => {
                                if (response.data.success && response.data.session) {
                                    this.focusMode.currentSession = response.data.session;
                                    this.focusMode.inSession = true;
                                    this.setupTimerFromSession(response.data.session);
                                }
                            })
                            .catch(error => {
                                console.error('检查活动会话失败:', error);
                            });
                    },
                    showStartFocusDialog() {
                        this.focusTaskForm = {
                            title: '',
                            description: '',
                            duration: this.focusMode.settings.work_duration
                        };
                        this.dialogType = 'startFocus';
                        this.dialogTitle = '开始专注';
                        this.dialogVisible = true;
                    },
                    startFocusSession() {
                        if (!this.focusTaskForm.title) {
                            this.$message.error('请输入任务标题');
                            return;
                        }
                        
                        const data = {
                            task_title: this.focusTaskForm.title,
                            task_description: this.focusTaskForm.description,
                            planned_duration: this.focusTaskForm.duration,
                            session_type: 'work'
                        };
                        
                        axios.post('/focus/session/start/', data)
                            .then(response => {
                                if (response.data.success) {
                                    this.focusMode.currentSession = response.data.session;
                                    this.focusMode.inSession = true;
                                    this.initTimer(this.focusTaskForm.duration * 60);
                                    this.dialogVisible = false;
                                    this.$message.success('专注会话已创建，点击开始按钮开始计时');
                                    // 注意：这里不自动开始计时器，等用户手动点击开始
                                } else {
                                    this.$message.error(response.data.error || '开始失败');
                                }
                            })
                            .catch(error => {
                                console.error('开始专注失败:', error);
                                this.$message.error('开始专注失败');
                            });
                    },
                    initTimer(seconds) {
                        this.focusMode.timer.duration = seconds;
                        this.focusMode.timer.remaining = seconds;
                        this.focusMode.timer.isRunning = false;
                        this.focusMode.timer.isPaused = false;
                    },
                    setupTimerFromSession(session) {
                        // 计算已过去的时间
                        const startTime = new Date(session.start_time);
                        const now = new Date();
                        const elapsed = Math.floor((now - startTime) / 1000);
                        const totalDuration = session.planned_duration * 60;
                        const remaining = Math.max(0, totalDuration - elapsed);
                        
                        this.initTimer(totalDuration);
                        this.focusMode.timer.remaining = remaining;
                        
                        if (remaining <= 0) {
                            // 时间已到，自动结束会话
                            this.$message.warning('检测到未完成的专注会话已超时，已自动结束');
                            this.endSession(false, true);
                        } else {
                            // 显示恢复提示
                            this.$confirm(`检测到未完成的专注会话："${session.task_title}"，剩余 ${this.formatTime(remaining)}，是否继续？`, '恢复专注会话', {
                                confirmButtonText: '继续专注',
                                cancelButtonText: '结束会话',
                                type: 'info'
                            }).then(() => {
                                // 用户选择继续，自动开始计时器
                                this.startTimer();
                            }).catch(() => {
                                // 用户选择结束会话
                                this.endSession(false, true);
                            });
                        }
                    },
                    startTimer() {
                        // 防止重复启动计时器
                        if (this.timerInterval) {
                            clearInterval(this.timerInterval);
                            this.timerInterval = null;
                        }
                        
                        this.focusMode.timer.isRunning = true;
                        this.focusMode.timer.isPaused = false;
                        
                        this.timerInterval = setInterval(() => {
                            if (this.focusMode.timer.remaining > 0) {
                                this.focusMode.timer.remaining--;
                            } else {
                                this.timerComplete();
                            }
                        }, 1000);
                    },
                    pauseTimer() {
                        this.focusMode.timer.isPaused = true;
                        this.focusMode.timer.isRunning = false;
                        if (this.timerInterval) {
                            clearInterval(this.timerInterval);
                            this.timerInterval = null;
                        }
                    },
                    resumeTimer() {
                        // 确保之前的计时器已经清除
                        if (this.timerInterval) {
                            clearInterval(this.timerInterval);
                            this.timerInterval = null;
                        }
                        this.startTimer();
                    },
                    timerComplete() {
                        this.pauseTimer();
                        this.endSession(true);
                        this.$message.success('专注时间结束！');
                        
                        // 播放声音提醒（如果启用）
                        if (this.focusMode.settings.sound_enabled) {
                            this.playNotificationSound();
                        }
                    },
                    stopSession() {
                        this.$confirm('确定要结束当前专注会话吗？', '确认', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            this.endSession(false, true);
                        });
                    },
                    endSession(completed = false, interrupted = false) {
                        if (!this.focusMode.currentSession) return;
                        
                        const data = {
                            session_id: this.focusMode.currentSession.id,
                            completed: completed,
                            interrupted: interrupted
                        };
                        
                        axios.post('/focus/session/end/', data)
                            .then(response => {
                                if (response.data.success) {
                                    this.focusMode.inSession = false;
                                    this.focusMode.currentSession = null;
                                    this.pauseTimer();
                                    this.loadFocusData(); // 刷新数据
                                    this.$message.success('专注会话已结束');
                                }
                            })
                            .catch(error => {
                                console.error('结束会话失败:', error);
                                this.$message.error('结束会话失败');
                            });
                    },
                    formatTime(seconds) {
                        // 确保seconds是一个有效的数字
                        if (isNaN(seconds) || seconds < 0) {
                            seconds = 0;
                        }
                        const minutes = Math.floor(seconds / 60);
                        const remainingSeconds = seconds % 60;
                        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                    },
                    formatDuration(minutes) {
                        // 格式化时长显示，如 "1h 30m" 或 "25m"
                        if (isNaN(minutes) || minutes < 0) {
                            minutes = 0;
                        }
                        const hours = Math.floor(minutes / 60);
                        const remainingMinutes = minutes % 60;
                        
                        if (hours > 0) {
                            return `${hours}h ${remainingMinutes}m`;
                        } else {
                            return `${remainingMinutes}m`;
                        }
                    },
                    showFocusSettings() {
                        this.dialogType = 'focusSettings';
                        this.dialogTitle = '专注设置';
                        this.dialogVisible = true;
                    },
                    updateFocusSettings() {
                        axios.post('/focus/settings/update/', this.focusMode.settings)
                            .then(response => {
                                if (response.data.success) {
                                    this.$message.success('设置已保存');
                                    this.dialogVisible = false;
                                }
                            })
                            .catch(error => {
                                console.error('更新设置失败:', error);
                                this.$message.error('保存设置失败');
                            });
                    },
                    playNotificationSound() {
                        // 简单的声音提醒实现
                        try {
                            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvGIcBjuX2/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGIcBjuX2/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGIcBjuX2/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvGIcBjuX2/LNdBGdgLgVIkA=');
                            audio.play();
                        } catch (error) {
                            console.log('播放提醒音失败:', error);
                        }
                    },
                    showAllHistory() {
                        this.dialogType = 'focusHistory';
                        this.dialogTitle = '专注历史记录';
                        this.dialogVisible = true;
                        // 加载更多历史记录
                        this.loadAllFocusHistory();
                    },
                    loadAllFocusHistory() {
                        axios.get('/focus/history/?limit=100')
                            .then(response => {
                                if (response.data.success) {
                                    this.focusHistory = response.data.sessions;
                                }
                            })
                            .catch(error => {
                                console.error('获取完整历史失败:', error);
                                this.$message.error('获取历史记录失败');
                            });
                    },
                    fetchTasks() {
                        this.loading = true;
                        axios.get('/checkin/checkins/')
                            .then(response => {
                                this.checkins = response.data;
                                this.loading = false;
                            })
                            .catch(error => {
                                console.error('获取任务失败:', error);
                                this.loading = false;
                                this.$message.error('获取任务失败，请刷新页面重试');
                            });
                    },
                    createTask() {
                        if (!this.newTask.title) {
                            this.$message.error('任务名称不能为空');
                            return;
                        }
                        
                        this.loading = true;
                        axios.post('/checkin/checkins/create/', this.newTask)
                            .then(response => {
                                this.dialogVisible = false;
                                this.checkins.unshift(response.data.checkin);
                                this.$message.success('任务创建成功');
                                
                                // 重置表单
                                this.newTask = {
                                    title: '',
                                    time: '',
                                    description: ''
                                };
                                
                                this.loading = false;
                            })
                            .catch(error => {
                                console.error('创建任务失败:', error);
                                this.loading = false;
                                this.$message.error('创建任务失败，请重试');
                            });
                    },
                    deleteCheckin(checkin) {
                        this.$confirm('确定要删除此任务吗?', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            this.loading = true;
                            axios.delete(`/checkin/checkins/${checkin.id}/delete/`)
                                .then(response => {
                                    const index = this.checkins.findIndex(c => c.id === checkin.id);
                                    if (index !== -1) {
                                        this.checkins.splice(index, 1);
                                    }
                                    this.$message.success('任务已删除');
                                    this.loading = false;
                                })
                                .catch(error => {
                                    console.error('删除任务失败:', error);
                                    this.loading = false;
                                    this.$message.error('删除失败，请重试');
                                });
                        }).catch(() => {
                            // 取消删除
                        });
                    },
                    loadUserData() {
                        this.loading = true;
                        Promise.all([
                            axios.get('/accounts/profile/'),
                            axios.get('/checkin/checkins/'),
                            axios.get('/checkin/community/')
                        ])
                        .then(([ profileResponse, checkinsResponse, communityResponse]) => {
                        
                            this.userInfo = profileResponse.data.data;
                            this.checkins = checkinsResponse.data;
                            this.communityCheckins = communityResponse.data;
                            
                            setTimeout(() => {
                                this.loading = false;
                            }, 200); // 添加短暂延迟，确保动画平滑
                        })
                        .catch(error => {
                            console.error('加载用户数据失败:', error);
                            this.loading = false;
                            
                            if (error.response && error.response.status === 401) {
                                // 未登录，重定向到登录页
                                this.isLoggedIn = false;
                            } else {
                                this.$message.error('加载用户数据失败，请刷新页面重试');
                            }
                        });
                    },
                    refreshCommunity() {
                        this.loading = true;
                        axios.get('/checkin/community/')
                            .then(response => {
                                this.communityCheckins = response.data;
                                setTimeout(() => {
                                    this.loading = false;
                                }, 200); // 添加短暂延迟，确保动画平滑
                                this.$message.success('已刷新打卡动态');
                            })
                            .catch(error => {
                                console.error('刷新打卡动态失败:', error);
                                this.loading = false;
                                this.$message.error('刷新失败，请重试');
                            });
                    },
                    sendOldEmailCode() {
                        if (!this.userInfo.email) {
                            this.$message.error('原邮箱为空，无法发送验证码');
                            return;
                        }
                        
                        axios.post('/accounts/send-verification-code/', {
                            email: this.userInfo.email
                        })
                        .then(response => {
                            this.$message.success('验证码已发送到原邮箱');
                            this.oldCodeSending = true;
                            this.oldCodeTimer = 60;
                            
                            // 倒计时
                            const timer = setInterval(() => {
                                this.oldCodeTimer -= 1;
                                if (this.oldCodeTimer <= 0) {
                                    clearInterval(timer);
                                    this.oldCodeSending = false;
                                }
                            }, 1000);
                        })
                        .catch(error => {
                            this.$message.error(error.response?.data?.error || '发送验证码失败');
                        });
                    },
                    sendNewEmailCode() {
                        if (!this.emailForm.newEmail) {
                            this.$message.error('新邮箱不能为空');
                            return;
                        }
                        
                        const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                        if (!emailRegex.test(this.emailForm.newEmail)) {
                            this.$message.error('请输入有效的邮箱地址');
                            return;
                        }
                        
                        axios.post('/accounts/send-verification-code/', {
                            email: this.emailForm.newEmail
                        })
                        .then(response => {
                            this.$message.success('验证码已发送到新邮箱');
                            this.newCodeSending = true;
                            this.newCodeTimer = 60;
                            
                            // 倒计时
                            const timer = setInterval(() => {
                                this.newCodeTimer -= 1;
                                if (this.newCodeTimer <= 0) {
                                    clearInterval(timer);
                                    this.newCodeSending = false;
                                }
                            }, 1000);
                        })
                        .catch(error => {
                            this.$message.error(error.response?.data?.error || '发送验证码失败');
                        });
                    },
                    updateEmail() {
                        // 验证表单
                        if (!this.emailForm.oldCode) {
                            this.$message.error('请输入原邮箱验证码');
                            return;
                        }
                        
                        if (!this.emailForm.newEmail) {
                            this.$message.error('请输入新邮箱');
                            return;
                        }
                        
                        if (!this.emailForm.newCode) {
                            this.$message.error('请输入新邮箱验证码');
                            return;
                        }
                        
                        const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                        if (!emailRegex.test(this.emailForm.newEmail)) {
                            this.$message.error('请输入有效的邮箱地址');
                            return;
                        }
                        
                        this.loading = true;
                        
                        axios.post('/accounts/update-email/', {
                            old_email: this.userInfo.email,
                            old_code: this.emailForm.oldCode,
                            new_email: this.emailForm.newEmail,
                            new_code: this.emailForm.newCode
                        })
                        .then(response => {
                            this.loading = false;
                            this.dialogVisible = false;
                            
                            // 更新用户信息
                            this.userInfo = response.data.user;
                            
                            // 更新本地存储
                            localStorage.setItem('user', JSON.stringify(this.userInfo));
                            
                            this.$message.success('邮箱更新成功');
                            
                            // 重置表单
                            this.emailForm = {
                                oldCode: '',
                                newEmail: '',
                                newCode: ''
                            };
                        })
                        .catch(error => {
                            this.loading = false;
                            this.$message.error(error.response?.data?.error || '更新邮箱失败');
                        });
                    },
                    viewPostDetail(post) {
                        // 跳转到帖子详情页
                        window.location.href = `/post_${post.id}.html`;
                    },
                    createPost() {
                        if (!this.newPost.title || !this.newPost.content) {
                            this.$message.error('帖子标题和内容不能为空');
                            return;
                        }
                        
                        // 确保选择了学校
                        if (!this.selectedSchool || !this.selectedSchool.id) {
                            this.$message.error('请先选择一个学校');
                            return;
                        }
                        
                        // 添加学校ID到请求数据
                        const postData = {
                            ...this.newPost,
                            school_id: this.selectedSchool.id
                        };
                        
                        this.loading = true;
                        axios.post('/forum/posts/create/', postData)
                            .then(response => {
                                this.dialogVisible = false;
                                
                                // 获取创建的帖子
                                const newPost = response.data.post || response.data;
                                
                                // 将新帖子添加到用户帖子列表
                                this.userPosts.unshift(newPost);
                                
                                this.$message.success('帖子发布成功，等待管理员审核');
                                
                                // 重置表单
                                this.newPost = {
                                    title: '',
                                    content: ''
                                };
                                
                                this.loading = false;
                            })
                            .catch(error => {
                                console.error('发布帖子失败:', error);
                                this.loading = false;
                                this.$message.error('发布帖子失败，请重试');
                            });
                    },
                    createPostDetailPage(post) {
                        // 发送请求创建帖子详情页面
                        axios.post('/forum/posts/generate-html/', { post_id: post.id })
                            .then(response => {
                                console.log('帖子详情页面已生成');
                            })
                            .catch(error => {
                                console.error('生成帖子详情页面失败:', error);
                            });
                    },
                    getStatusType(status) {
                        // 根据帖子状态返回相应的标签类型
                        switch (status) {
                            case 'pending':
                                return 'info';
                            case 'approved':
                                return 'success';
                            case 'rejected':
                                return 'danger';
                            default:
                                return 'info';
                        }
                    },
                    goToAdminPage() {
                        // 跳转到管理员页面
                        window.location.href = '/admin_center/admin/';
                    },
                    toggleDarkMode() {
                        // 实现夜间模式切换逻辑
                        console.log('夜间模式切换', this.settings.darkMode);
                        if (this.settings.darkMode) {
                            document.body.classList.add('dark-mode');
                            this.$message({
                                message: '已开启夜间模式',
                                type: 'success',
                                duration: 1500,
                                offset: 50
                            });
                        } else {
                            document.body.classList.remove('dark-mode');
                            this.$message({
                                message: '已关闭夜间模式',
                                type: 'info',
                                duration: 1500,
                                offset: 50
                            });
                        }
                        
                        // 保存设置到本地存储
                        this.saveSettings();
                    },
                    saveSettings() {
                        // 保存设置到本地存储
                        localStorage.setItem('settings', JSON.stringify(this.settings));
                    },
                    loadSettings() {
                        // 从本地存储加载设置
                        const savedSettings = localStorage.getItem('settings');
                        if (savedSettings) {
                            try {
                                const parsedSettings = JSON.parse(savedSettings);
                                this.settings = { ...this.settings, ...parsedSettings };
                                
                                // 应用夜间模式设置
                                if (this.settings.darkMode) {
                                    document.body.classList.add('dark-mode');
                                } else {
                                    document.body.classList.remove('dark-mode');
                                }
                            } catch (e) {
                                console.error('解析设置失败:', e);
                            }
                        }
                    },
                    fetchForumData() {
                        if (!this.selectedSchool.id) return;
                        
                        this.loading = true;
                        Promise.all([
                            axios.get(`/forum/posts/?school_id=${this.selectedSchool.id}`),
                            axios.get('/forum/posts/user/') // 获取用户自己的帖子
                        ])
                        .then(([postsResponse, userPostsResponse]) => {
                            this.posts = postsResponse.data;
                            this.userPosts = userPostsResponse.data;
                            setTimeout(() => {
                                this.loading = false;
                            }, 200); // 添加短暂延迟，确保动画平滑
                        })
                        .catch(error => {
                            console.error('获取论坛数据失败:', error);
                            this.loading = false;
                            this.$message.error('获取论坛数据失败，请刷新页面重试');
                        });
                    },
                    enterChatRoom() {
                        // 根据选择的学校进入相应的聊天室
                        if (!this.selectedSchool || !this.selectedSchool.id) {
                            this.$message.error('请先选择一个学校');
                            return;
                        }
                        
                        // 跳转到对应学校的聊天室
                        window.location.href = `/chat/room/${this.selectedSchool.id}/`;
                    }
                },
                beforeDestroy() {
                    // 清理计时器
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                        this.timerInterval = null;
                    }
                },
                mounted() {
                    console.log("Vue实例已挂载");
                    // 检查登录状态
                    this.checkLoginStatus();
                    
                    // 加载用户设置
                    this.loadSettings();
                    
                    // 加载用户数据
                    this.loading = true;
                    this.loadUserData();
                    
                    // 加载专注模式数据
                    if (this.isLoggedIn) {
                        this.loadFocusData();
                    }
                    
                    // 获取学校列表
                    this.fetchSchools();
                    
                    // 隐藏静态内容
                    let staticContent = document.getElementById('static-content');
                    if (staticContent) {
                        staticContent.style.display = 'none';
                    }
                    
                    // 标记初始化完成
                    this.initialized = true;
                }
            });
        });
        
        // 立即确保app显示
        window.onload = function() {
            var appElement = document.getElementById('app');
            if (appElement) {
                // 不在这里设置display:block，而是依赖v-cloak指令和Vue初始化后自动显示
            }
            
            setTimeout(function() {
                var staticContent = document.getElementById('static-content');
                if (staticContent) {
                    staticContent.style.display = 'none';
                }
            }, 500);
        };
    </script>
</body>
</html> 