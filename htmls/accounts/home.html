<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园APP</title>
    <!-- 引入Vue.js和Axios -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入Element UI -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- 高德地图API - 请替换为您的实际KEY，申请地址：https://lbs.amap.com/dev/key -->
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=9ca613717390ebddd7fd7c1c107bb353"></script>
    <!-- 引入自定义样式 -->
    <link rel="stylesheet" href="/static/accounts/css/styles.css">
    

    <style>
        /* 添加v-cloak指令的CSS，防止闪现未编译的模板 */
        [v-cloak] {
            display: none;
        }
        
        /* APP布局样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            position: relative;
        }
        
        /* 顶部导航栏 */
        .top-bar {
            background-color: #409EFF;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 50px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .top-bar .title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            flex: 1;
        }
        
        .top-bar .action-btn {
            font-size: 20px;
            cursor: pointer;
            min-width: 40px;
            display: flex;
            justify-content: flex-end;
        }
        
        /* 内容区域 */
        .content-area {
            flex: 1;
            margin-top: 74px;
            margin-bottom: 60px;
            padding: 15px;
            overflow-y: auto;
            z-index: 10; /* 确保内容区域在导航栏之下 */
            position: relative;
            transition: opacity 0.3s ease;
        }
        
        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .nav-item {
            text-align: center;
            padding: 5px 0;
            width: 33.33%;
            cursor: pointer;
            color: #666;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .nav-item.active {
            color: #409EFF;
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 3px;
        }
        
        /* 学校选择器 */
        .school-selector {
            background-color: white;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* 卡片样式 */
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 论坛帖子 */
        .post-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            border-radius: 4px;
        }
        
        .post-item:hover {
            background-color: #ecf5ff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .post-item:last-child {
            border-bottom: none;
        }
        
        .post-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #303133;
        }
        
        .title-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .post-item:hover .title-text {
            color: #409EFF;
        }
        
        .post-title i {
            opacity: 0;
            transition: all 0.3s ease;
            margin-left: 5px;
        }
        
        .post-item:hover .post-title i {
            opacity: 1;
            transform: translateX(3px);
            color: #409EFF;
        }
        
        /* 帖子操作区域样式 */
        .post-actions {
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
            margin-top: 8px;
        }
        
        .action-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .action-group .el-button {
            color: #666;
            padding: 4px 8px;
            font-size: 13px;
        }
        
        .action-group .el-button:hover {
            color: #409EFF;
            background-color: #ecf5ff;
        }
        
        .action-group .el-button.liked {
            color: #f39c12;
        }
        
        .action-group .el-button.liked:hover {
            color: #e67e22;
        }
        
        /* 评论对话框样式 */
        .comments-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .post-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .post-info h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #333;
        }
        
        .post-author {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .comment-form {
            margin-bottom: 20px;
        }
        
        .form-actions {
            margin-top: 10px;
            text-align: right;
        }
        
        .login-prompt {
            text-align: center;
            padding: 20px;
            color: #999;
            border: 2px dashed #ddd;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .comments-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .loading, .no-comments {
            text-align: center;
            padding: 40px 0;
            color: #999;
        }
        
        .comment-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .comment-item:last-child {
            border-bottom: none;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .comment-author {
            font-weight: bold;
            color: #333;
        }
        
        .comment-time {
            color: #999;
            font-size: 12px;
        }
        
        .comment-content {
            color: #555;
            line-height: 1.6;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        
        .comment-actions {
            text-align: right;
        }
        
        .comment-actions .el-button {
            color: #999;
            padding: 2px 6px;
        }
        
        .comment-actions .el-button:hover {
            color: #409EFF;
        }
        
        .replies {
            margin-left: 20px;
            margin-top: 10px;
            border-left: 3px solid #eee;
            padding-left: 15px;
        }
        
        .reply-item {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .reply-item:last-child {
            border-bottom: none;
        }
        
        .post-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #909399;
        }
        
        /* 打卡项目 */
        .checkin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .checkin-item:last-child {
            border-bottom: none;
        }
        
        .checkin-info {
            flex: 1;
        }
        
        .checkin-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .checkin-time {
            font-size: 12px;
            color: #999;
        }
        
        /* 个人中心菜单 */
        .profile-menu {
            display: flex;
            flex-direction: column;
        }
        
        .menu-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            border-radius: 4px;
        }
        
        .menu-item:hover {
            background-color: #ecf5ff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item i.el-icon-arrow-right {
            opacity: 0;
            transition: all 0.3s ease;
            margin-left: 5px;
        }
        
        .menu-item:hover i.el-icon-arrow-right {
            opacity: 1;
            transform: translateX(3px);
            color: #409EFF;
        }
        
        body.dark-mode .menu-item:hover {
            background-color: #2a2a2a;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .menu-item:hover i.el-icon-arrow-right {
            color: #87CEFA;
        }
        
        .menu-item-left {
            display: flex;
            align-items: center;
            transition: color 0.3s ease;
        }
        
        .menu-item:hover .menu-item-left {
            color: #409EFF;
        }
        
        body.dark-mode .menu-item:hover .menu-item-left {
            color: #87CEFA;
        }
        
        .menu-icon {
            margin-right: 10px;
            color: #409EFF;
            font-size: 18px;
            transition: transform 0.3s ease, color 0.3s ease;
        }
        
        .menu-item:hover .menu-icon {
            transform: scale(1.2);
        }
        
        body.dark-mode .menu-icon {
            color: #87CEFA;
        }
        
        .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }
        
        .avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #409EFF;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .user-name {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .user-info {
            font-size: 12px;
            color: #999;
        }
        
        /* 调试区域样式 */
        #debug {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px;
            font-family: monospace;
            font-size: 12px;
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            z-index: 2000;
            display: none; /* 默认隐藏调试信息 */
        }
        #debug-log {
            max-height: 180px;
            overflow-y: auto;
        }
        #debug-log p {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        .task-section {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .task-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .task-title {
            font-weight: bold;
        }
        .task-info {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
        }
        .task-actions {
            margin-top: 8px;
        }
        /* 打卡社区样式 */
        .community-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .community-item:last-child {
            border-bottom: none;
        }
        
        .community-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .community-user {
            font-weight: bold;
            color: #409EFF;
        }
        
        .community-time {
            font-size: 12px;
            color: #999;
        }
        
        .community-content {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .community-task {
            font-weight: bold;
            color: #67C23A;
        }
        
        /* 分页样式 */
        .forum-pagination, .community-pagination {
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .pagination-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .pagination-loading i {
            margin-right: 8px;
            color: #409EFF;
        }
        
        /* 分页组件样式调整 */
        .el-pagination {
            justify-content: center;
        }
        
        .el-pagination.is-background .el-pager li:not(.disabled):hover {
            color: #409EFF;
        }
        
        .el-pagination.is-background .el-pager li:not(.disabled).active {
            background-color: #409EFF;
            color: white;
        }
        
        /* 任务项目样式 */
        .task-title {
            font-weight: bold;
        }
        
        .task-info {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
        }
        
        .task-actions {
            margin-top: 8px;
        }
        
        /* 夜间模式样式 */
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .card, .top-bar, .post-header, .post-content, .school-selector, .bottom-nav, 
        .el-dialog, .el-dropdown-menu, .el-button--default, .el-input__inner, .el-textarea__inner {
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        
        .card-title, .post-title, .user-name, .post-meta, .user-info, .checkin-time, .menu-item, 
        .checkin-item, .community-item, .task-item, .el-dropdown-menu__item, .el-dialog__title, .el-dialog__close {
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        
        body.dark-mode .top-bar {
            background-color: #1f1f1f;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .card,
        body.dark-mode .post-header,
        body.dark-mode .post-content,
        body.dark-mode .school-selector,
        body.dark-mode .bottom-nav {
            background-color: #1f1f1f;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .card-title,
        body.dark-mode .post-title,
        body.dark-mode .user-name {
            color: #e0e0e0;
        }
        
        body.dark-mode .post-meta,
        body.dark-mode .user-info,
        body.dark-mode .checkin-time {
            color: #aaaaaa;
        }
        
        body.dark-mode .post-item {
            border-bottom: 1px solid #333;
        }
        
        body.dark-mode .post-item:hover {
            background-color: #2a2a2a;
        }
        
        body.dark-mode .menu-item,
        body.dark-mode .checkin-item,
        body.dark-mode .community-item,
        body.dark-mode .task-item {
            border-bottom: 1px solid #333;
        }
        
        body.dark-mode .el-dropdown-menu {
            background-color: #1f1f1f;
            border-color: #333;
        }
        
        body.dark-mode .el-dropdown-menu__item {
            color: #e0e0e0;
        }
        
        body.dark-mode .el-dropdown-menu__item:hover {
            background-color: #2a2a2a;
            color: #409EFF;
        }
        
        body.dark-mode .el-dialog {
            background-color: #1f1f1f;
            border-color: #333;
        }
        
        body.dark-mode .el-dialog__title {
            color: #e0e0e0;
        }
        
        body.dark-mode .el-input__inner {
            background-color: #2a2a2a;
            border-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .el-textarea__inner {
            background-color: #2a2a2a;
            border-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .el-button--default {
            background-color: #2a2a2a;
            border-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .el-dialog__headerbtn .el-dialog__close {
            color: #e0e0e0;
        }
        
        /* 夜间模式分页样式 */
        body.dark-mode .forum-pagination {
            border-top: 1px solid #333;
        }
        
        body.dark-mode .pagination-loading {
            color: #aaaaaa;
        }
        
        body.dark-mode .el-pagination__total,
        body.dark-mode .el-pagination__jump {
            color: #e0e0e0;
        }
        
        body.dark-mode .el-pagination .el-select .el-input__inner {
            background-color: #2a2a2a;
            border-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .el-pagination .btn-prev,
        body.dark-mode .el-pagination .btn-next {
            background-color: #2a2a2a;
            border-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .el-pagination .el-pager li {
            background-color: #2a2a2a;
            border-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .el-pagination .el-pager li:hover {
            color: #409EFF;
        }
        
        body.dark-mode .el-pagination .el-pager li.active {
            background-color: #409EFF;
            color: white;
        }
        
        /* 搜索界面样式 */
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .search-input .el-input__inner {
            border-radius: 20px;
        }
        
        .search-input .el-button {
            border-radius: 0 20px 20px 0;
        }
        
        .search-history {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .history-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .history-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .history-tag {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-tag:hover {
            background-color: #409EFF;
            color: white;
        }
        
        .search-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f9ff;
            border-left: 4px solid #409EFF;
            border-radius: 4px;
        }
        
        .search-stats {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #666;
        }
        
        .search-stats i {
            margin-right: 5px;
            color: #409EFF;
        }
        
        .search-stats strong {
            color: #409EFF;
        }
        
        .clear-search-btn {
            margin-left: auto;
            color: #666;
        }
        
        .clear-search-btn:hover {
            color: #409EFF;
        }
        
        /* 搜索关键词高亮 */
        .search-highlight {
            background-color: #fff3cd;
            color: #856404;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
        
        /* 夜间模式搜索样式 */
        body.dark-mode .search-history {
            background-color: #2a2a2a;
        }
        
        body.dark-mode .history-title {
            color: #aaaaaa;
        }
        
        body.dark-mode .search-info {
            background-color: #2a2a2a;
            border-left-color: #409EFF;
        }
        
        body.dark-mode .search-stats {
            color: #aaaaaa;
        }
        
        body.dark-mode .clear-search-btn {
            color: #aaaaaa;
        }
        
        body.dark-mode .clear-search-btn:hover {
            color: #409EFF;
        }
        
        body.dark-mode .search-highlight {
            background-color: #856404;
            color: #fff3cd;
        }
        
        /* 内容过渡效果 */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s;
        }
        .fade-enter, .fade-leave-to {
            opacity: 0;
        }
        
        /* 加载遮罩层 */
        .loading-overlay {
            position: fixed;
            top: 74px;
            bottom: 60px;
            left: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            transition: opacity 0.3s ease;
        }
        
        body.dark-mode .loading-overlay {
            background-color: rgba(31, 31, 31, 0.8);
        }
        
        body.dark-mode .loading-overlay p {
            color: #e0e0e0;
                    }
            
            /* 专注模式样式已删除 */
        </style>
</head>
<body>
    <!-- 添加v-cloak指令，防止Vue模板闪现 -->
    <div id="app" v-cloak>
        <div class="app-container">
            <!-- 顶部导航栏 -->
            <div class="top-bar">
                <!-- 左侧区域 -->
                <div class="action-btn" v-if="currentTab === 'forum'">
                    <i class="el-icon-location"></i>
                    <el-dropdown @command="changeSchool" trigger="click">
                        <span class="title">{{ selectedSchool.name }} <i class="el-icon-arrow-down el-icon--right"></i></span>
                        <el-dropdown-menu slot="dropdown">
                            <el-dropdown-item v-for="school in schools" :key="school.id" :command="school.id">
                                {{ school.name }}
                            </el-dropdown-item>
                        </el-dropdown-menu>
                    </el-dropdown>
                </div>
                <div v-else style="width: 20px;"></div>
                
                <!-- 中间标题区域 -->
                <div class="title" v-if="currentTab === 'profile'">个人中心</div>
                <div class="title" v-else-if="currentTab === 'checkin'">打卡</div>
                <div class="title" v-else-if="currentTab === 'tasks'">打卡动态</div>
                <div class="title" v-else-if="currentTab === 'forum'"></div>
                
                <!-- 右侧按钮区域 -->
                <div class="action-btn" v-if="currentTab === 'forum'">
                    <i class="el-icon-chat-line-square" @click="enterChatRoom"></i>
                </div>
                <div class="action-btn" v-else-if="currentTab === 'checkin'">
                    <i class="el-icon-plus" @click="dialogVisible = true; dialogType = 'task'; dialogTitle = '创建新任务'"></i>
                </div>
                <div class="action-btn" v-else-if="currentTab === 'tasks'">
                    <i class="el-icon-refresh" @click="refreshCommunity"></i>
                </div>
                <div v-else style="width: 20px;"></div>
            </div>
            
            <!-- 内容区域 -->
            <div class="content-area">
                <!-- 首页欢迎板块 -->
                <div class="card" id="static-card" v-if="!initialized">
                    <div class="card-title">欢迎访问校园APP</div>
                    <div style="padding: 15px;">
                        <p>页面加载中，请稍候...</p>
                    </div>
                </div>
                
                <!-- 加载遮罩层 -->
                <transition name="fade">
                    <div v-if="loading" class="loading-overlay">
                        <div style="text-align: center;">
                            <i class="el-icon-loading" style="font-size: 30px; color: #409EFF;"></i>
                            <p style="margin-top: 10px; color: #606266;">加载中...</p>
                        </div>
                    </div>
                </transition>
                
                <!-- 调试信息 -->
                <div class="card" v-if="false">
                    <div class="card-title">加载中...</div>
                </div>
                
                <!-- 各模块内容 -->
                <div v-show="!loading">
                    <!-- 论坛板块 -->
                    <div v-if="currentTab === 'forum'">
                        <div class="card">
                            <div class="card-title">
                                {{ search.isSearchMode ? '搜索结果' : '热门帖子' }}
                                <el-button v-if="isLoggedIn" type="text" size="mini" @click="dialogVisible = true; dialogType = 'post'; dialogTitle = '创建新帖子'">
                                    发布帖子
                                </el-button>
                            </div>
                            
                            <!-- 搜索框 -->
                            <div class="search-container">
                                <el-input
                                    v-model="search.query"
                                    placeholder="搜索帖子标题、内容或作者..."
                                    @input="handleSearchInput"
                                    @keyup.enter="performSearch(search.query)"
                                    @keyup.esc="clearSearch"
                                    clearable
                                    prefix-icon="el-icon-search"
                                    class="search-input">
                                    <el-button 
                                        slot="append" 
                                        @click="performSearch(search.query)"
                                        :loading="search.loading"
                                        :disabled="!search.query.trim()">
                                        搜索
                                    </el-button>
                                </el-input>
                                
                                <!-- 搜索历史 -->
                                <div v-if="search.history.length > 0 && !search.isSearchMode && search.query.length === 0" class="search-history">
                                    <div class="history-title">搜索历史</div>
                                    <div class="history-items">
                                        <el-tag
                                            v-for="(item, index) in search.history"
                                            :key="index"
                                            size="mini"
                                            type="info"
                                            effect="plain"
                                            @click="useSearchHistory(item)"
                                            class="history-tag">
                                            {{ item }}
                                        </el-tag>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 搜索结果信息 -->
                            <div v-if="search.isSearchMode" class="search-info">
                                <div class="search-stats">
                                    <i class="el-icon-search"></i>
                                    找到 <strong>{{ search.totalFound }}</strong> 条结果
                                    <span v-if="search.searchTime">，用时 {{ search.searchTime }}</span>
                                    <el-button type="text" size="mini" @click="clearSearch" class="clear-search-btn">
                                        <i class="el-icon-close"></i> 清空搜索
                                    </el-button>
                                </div>
                            </div>
                            <div class="post-item" v-for="post in filteredPosts" :key="post.id">
                                <div class="post-title" @click="viewPostDetail(post)">
                                    <span class="title-text" v-if="!search.isSearchMode">{{ post.title }}</span>
                                    <span class="title-text" v-else v-html="highlightKeywords(post.title, search.query.split())"></span>
                                    <i class="el-icon-arrow-right" style="font-size: 14px; color: #909399;"></i>
                                </div>
                                <div class="post-meta" @click="viewPostDetail(post)">
                                    <span v-if="!search.isSearchMode">
                                        <i class="el-icon-user" style="margin-right: 4px;"></i>{{ post.author }}
                                    </span>
                                    <span v-else>
                                        <i class="el-icon-user" style="margin-right: 4px;"></i>
                                        <span v-html="highlightKeywords(post.author, search.query.split())"></span>
                                    </span>
                                    <span><i class="el-icon-time" style="margin-right: 4px;"></i>{{ post.time }}</span>
                                </div>
                                <!-- 点赞和评论区域 -->
                                <div class="post-actions" @click.stop>
                                    <div class="action-group">
                                        <el-button 
                                            type="text" 
                                            size="mini" 
                                            :class="{ 'liked': post.user_liked }"
                                            @click="toggleLike(post)"
                                            :disabled="!isLoggedIn">
                                            <i class="el-icon-star-off" v-if="!post.user_liked"></i>
                                            <i class="el-icon-star-on" v-else style="color: #f39c12;"></i>
                                            {{ post.likes_count || 0 }}
                                        </el-button>
                                        <el-button 
                                            type="text" 
                                            size="mini"
                                            @click="showComments(post)">
                                            <i class="el-icon-chat-line-round"></i>
                                            {{ post.comments_count || 0 }}
                                        </el-button>
                                    </div>
                                </div>
                            </div>
                            <div v-if="filteredPosts.length === 0" style="text-align: center; padding: 20px 0; color: #999;">
                                暂无帖子
                            </div>
                            <!-- 分页组件 -->
                            <div v-if="currentPagination.totalPages > 1" class="forum-pagination">
                                <div v-if="paginationLoading || search.loading" class="pagination-loading">
                                    <i class="el-icon-loading"></i>
                                    加载中...
                                </div>
                                <el-pagination
                                    v-else
                                    @size-change="handlePageSizeChange"
                                    @current-change="handlePageChange"
                                    :current-page="currentPagination.page"
                                    :page-sizes="[10, 20, 50]"
                                    :page-size="currentPagination.pageSize"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    :total="currentPagination.total"
                                    :pager-count="5"
                                    style="text-align: center; margin-top: 20px;"
                                    small>
                                </el-pagination>
                            </div>
                        </div>
                        
                        <!-- 用户自己发布的帖子 (包括待审核的) -->
                        <div class="card" v-if="userPosts.length > 0 || userPostsLoading">
                            <div class="card-title">
                                我的帖子
                                <el-button type="text" size="mini" @click="refreshUserPosts">刷新</el-button>
                            </div>
                            <div v-if="userPostsLoading" class="loading-container" style="text-align: center; padding: 20px;">
                                <i class="el-icon-loading"></i> 加载中...
                            </div>
                            <div v-else>
                                <div class="post-item" v-for="post in userPosts" :key="post.id">
                                    <div class="post-title" @click="viewPostDetail(post)">
                                        <span class="title-text">{{ post.title }}</span>
                                        <el-tag size="mini" :type="getStatusType(post.status)" style="margin-left: 10px;">
                                            {{ post.status_display }}
                                        </el-tag>
                                    </div>
                                    <div class="post-meta" @click="viewPostDetail(post)">
                                        <span><i class="el-icon-user" style="margin-right: 4px;"></i>{{ post.author }}</span>
                                        <span><i class="el-icon-time" style="margin-right: 4px;"></i>{{ post.time }}</span>
                                    </div>
                                    <!-- 点赞和评论区域 -->
                                    <div class="post-actions" @click.stop v-if="post.status === 'approved'">
                                        <div class="action-group">
                                            <el-button 
                                                type="text" 
                                                size="mini" 
                                                :class="{ 'liked': post.user_liked }"
                                                @click="toggleLike(post)"
                                                :disabled="!isLoggedIn">
                                                <i class="el-icon-star-off" v-if="!post.user_liked"></i>
                                                <i class="el-icon-star-on" v-else style="color: #f39c12;"></i>
                                                {{ post.likes_count || 0 }}
                                            </el-button>
                                            <el-button 
                                                type="text" 
                                                size="mini"
                                                @click="showComments(post)">
                                                <i class="el-icon-chat-line-round"></i>
                                                {{ post.comments_count || 0 }}
                                            </el-button>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="userPosts.length === 0" style="text-align: center; padding: 20px 0; color: #999;">
                                    您还没有发布过帖子
                                </div>
                                <!-- 分页组件 -->
                                <div v-if="userPostsPagination.totalPages > 1" class="forum-pagination">
                                    <div v-if="userPostsLoading" class="pagination-loading">
                                        <i class="el-icon-loading"></i>
                                        加载中...
                                    </div>
                                    <el-pagination
                                        v-else
                                        @size-change="handleUserPostsPageSizeChange"
                                        @current-change="handleUserPostsPageChange"
                                        :current-page="userPostsPagination.page"
                                        :page-sizes="[10, 20, 50]"
                                        :page-size="userPostsPagination.pageSize"
                                        layout="total, sizes, prev, pager, next, jumper"
                                        :total="userPostsPagination.total"
                                        :pager-count="5"
                                        style="text-align: center; margin-top: 20px;"
                                        small>
                                    </el-pagination>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 打卡板块 -->
                    <div v-if="currentTab === 'checkin'">
                        <div class="card">
                            <div class="card-title">
                                打卡任务
                                <el-button type="text" size="mini" @click="dialogVisible = true; dialogType = 'task'; dialogTitle = '创建新任务'">
                                    创建任务
                                </el-button>
                            </div>
                            <div class="task-item" v-for="checkin in filteredCheckins" :key="checkin.id">
                                <div class="task-header" style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div class="task-title" style="flex: 1;">{{ checkin.title }}</div>
                                    
                                </div>
                                <div class="task-info" v-if="checkin.time">时间要求: {{ checkin.time }}</div>
                                <div class="task-info" v-if="checkin.target_duration > 0">
                                    目标时长: {{ checkin.target_duration }}分钟
                                </div>
                                <div class="task-info" v-if="checkin.description">{{ checkin.description }}</div>
                                <div class="task-info" v-if="checkin.created_at">创建于: {{ checkin.created_at }}</div>
                                
                                <!-- 任务进行中的计时显示 -->
                                <div v-if="checkin.checked_today && checkin.studyTimer && checkin.studyTimer.duration >= 0" 
                                     class="task-progress" style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 4px;">
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-size: 16px; font-weight: bold;">
                                                计时时长: {{ formatStudyTime(checkin.studyTimer.duration || 0) }}
                                            </span>
                                            <span v-if="checkin.target_duration > 0" style="color: #999;">
                                                目标: {{ checkin.target_duration }}分钟
                                            </span>
                                        </div>
                                        <div v-if="checkin.target_duration > 0" style="margin: 5px 0;">
                                            <el-progress 
                                                :percentage="Math.min(100, Math.round((checkin.studyTimer.duration / 60) / checkin.target_duration * 100))"
                                                :status="checkin.studyTimer.duration >= checkin.target_duration * 60 ? 'success' : ''"
                                            ></el-progress>
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            <el-button 
                                                v-if="!checkin.studyTimer.isPaused" 
                                                size="mini" 
                                                type="warning" 
                                                @click="pauseStudyTimer(checkin)"
                                                style="flex: 1;">
                                                <i class="el-icon-video-pause"></i> 暂停
                                            </el-button>
                                            <el-button 
                                                v-else 
                                                size="mini" 
                                                type="success" 
                                                @click="resumeStudyTimer(checkin)"
                                                style="flex: 1;">
                                                <i class="el-icon-video-play"></i> 继续
                                            </el-button>
                                        </div>
                                        <div v-if="checkin.studyTimer.duration >= (checkin.target_duration || 25) * 60" 
                                             style="text-align: center; color: #67C23A;">
                                            <i class="el-icon-circle-check"></i> 已达到目标时长，您可以继续计时或结束
                                            <el-button 
                                                size="mini" 
                                                type="success" 
                                                @click="stopStudyTimer(checkin)"
                                                style="margin-top: 10px; width: 100%;">
                                                完成任务
                                            </el-button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 会话进行中的轨迹显示 -->
                                <div v-if="checkin.checked_today && checkin.active_session && checkin.active_session.current_duration >= 0 && (!checkin.today_checkin_data || !checkin.today_checkin_data.end_time)" 
                                     class="task-progress" style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 4px;">
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                                <span style="font-size: 16px; font-weight: bold;">
                                                    计时时长: {{ formatStudyTime(checkin.active_session.current_duration || 0) }}
                                                </span>
                                                <span v-if="checkin.target_duration > 0" style="color: #999; font-size: 14px;">
                                                    目标: {{ checkin.target_duration }}分钟
                                                </span>
                                            </div>
                                        </div>
                                        <div v-if="checkin.target_duration > 0" style="margin: 5px 0;">
                                            <el-progress 
                                                :percentage="Math.min(100, Math.round((checkin.active_session.current_duration / 60) / checkin.target_duration * 100))"
                                                :status="checkin.active_session.current_duration >= checkin.target_duration * 60 ? 'success' : ''"
                                            ></el-progress>
                                        </div>

                                        <div style="display: flex; gap: 10px;">
                                            <el-button 
                                                v-if="!checkin.active_session.is_paused" 
                                                size="mini" 
                                                type="warning" 
                                                @click="pauseSportTracking(checkin)"
                                                style="flex: 1;">
                                                <i class="el-icon-video-pause"></i> 暂停
                                            </el-button>
                                            <el-button 
                                                v-else 
                                                size="mini" 
                                                type="success" 
                                                @click="resumeSportTracking(checkin)"
                                                style="flex: 1;">
                                                <i class="el-icon-video-play"></i> 继续
                                            </el-button>
                                        </div>
                                        <div v-if="checkin.active_session.current_duration >= (checkin.target_duration || 25) * 60" 
                                             style="text-align: center; color: #67C23A;">
                                            <i class="el-icon-circle-check"></i> 已达到目标时长，您可以继续计时或结束
                                            <el-button 
                                                size="mini" 
                                                type="success" 
                                                @click="stopSportTracking(checkin)"
                                                style="margin-top: 10px; width: 100%;">
                                                完成任务
                                            </el-button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 已完成的打卡数据显示 -->
                                <div v-if="checkin.checked_today && checkin.today_checkin_data && !checkin.studyTimer && !checkin.active_session" 
                                     class="task-complete" style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 4px;">
                                    <div v-if="checkin.today_checkin_data && checkin.today_checkin_data.duration > 0">
                                        完成时长: {{ formatStudyTime(checkin.today_checkin_data.duration) }}
                                        <br>打卡时间: {{ checkin.today_checkin_data.checked_at }}
                                    </div>
                                    <div v-else-if="checkin.today_checkin_data && checkin.today_checkin_data.checked_at">
                                        打卡时间: {{ checkin.today_checkin_data.checked_at }}
                                    </div>
                                    <div v-else style="color: #999; font-size: 12px;">
                                        ✓ 今日已打卡
                                    </div>
                                </div>
                                
                                <div class="task-actions">
                                    <el-button 
                                        size="mini" 
                                        type="success" 
                                        :disabled="checkin.checked_today && !hasProgressInStorage(checkin)" 
                                        @click="doCheckin(checkin)">
                                        {{ getCheckinButtonText(checkin) }}
                                    </el-button>
                                    <el-button 
                                        size="mini" 
                                        type="danger" 
                                        v-if="checkin.is_creator"
                                        @click="deleteCheckin(checkin)">
                                        删除
                                    </el-button>
                                </div>
                            </div>
                            <div v-if="filteredCheckins.length === 0" style="text-align: center; padding: 20px 0; color: #999;">
                                暂无打卡任务，创建一个新任务吧！
                            </div>
                        </div>
                    </div>
                    
                    <!-- 打卡社区板块 -->
                    <div v-if="currentTab === 'tasks'">
                        <div class="card">
                            <div class="card-title">
                                打卡动态
                                <el-button type="text" size="mini" @click="refreshCommunity">刷新</el-button>
                            </div>
                            <div v-if="communityCheckins.length === 0" style="text-align: center; padding: 20px 0; color: #999;">
                                暂无打卡动态
                            </div>
                            <div class="community-item" v-for="record in communityCheckins" :key="record.id">
                                <div class="community-header">
                                    <span class="community-user">{{ record.username }}</span>
                                    <span class="community-time">{{ record.checked_at }}</span>
                                </div>
                                <div class="community-content">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span>打卡了</span>
                                        <span class="community-task">{{ record.checkin_title }}</span>
                                    </div>
                                    <!-- 显示完成时长 -->
                                    <div v-if="record.duration > 0" 
                                         style="margin-top: 5px; font-size: 12px; color: #999;">
                                        完成时长: {{ formatStudyTime(record.duration) }}
                                    </div>
                                    <!-- 显示备注 -->
                                    <div v-if="record.notes" 
                                         style="margin-top: 5px; font-size: 12px; color: #666;">
                                        {{ record.notes }}
                                    </div>
                                </div>
                            </div>
                            <!-- 分页组件 -->
                            <div v-if="communityPagination.totalPages > 1" class="community-pagination">
                                <div v-if="communityLoading" class="pagination-loading">
                                    <i class="el-icon-loading"></i>
                                    加载中...
                                </div>
                                <el-pagination
                                    v-else
                                    @size-change="handleCommunityPageSizeChange"
                                    @current-change="handleCommunityPageChange"
                                    :current-page="communityPagination.page"
                                    :page-sizes="[10, 20, 50]"
                                    :page-size="communityPagination.pageSize"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    :total="communityPagination.total"
                                    :pager-count="5"
                                    style="text-align: center; margin-top: 20px;"
                                    small>
                                </el-pagination>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 专注模式板块已删除 -->
                    
                    <!-- 个人中心板块 -->
                    <div v-if="currentTab === 'profile'">
                        <div class="card">
                            <div class="avatar-container">
                                <div class="avatar">{{ avatarInitial }}</div>
                                <div class="user-name">{{ displayUsername }}</div>
                                <div class="user-info">{{ userInfo.email }}</div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="profile-menu">
                                <div class="menu-item" @click="showProfile">
                                    <div class="menu-item-left">
                                        <i class="el-icon-user menu-icon"></i>
                                        <span>个人资料</span>
                                    </div>
                                    <i class="el-icon-arrow-right"></i>
                                </div>
                                <div class="menu-item" @click="showSettings">
                                    <div class="menu-item-left">
                                        <i class="el-icon-setting menu-icon"></i>
                                        <span>设置</span>
                                    </div>
                                    <i class="el-icon-arrow-right"></i>
                                </div>
                                <div class="menu-item" @click="showSecurity">
                                    <div class="menu-item-left">
                                        <i class="el-icon-lock menu-icon"></i>
                                        <span>安全中心</span>
                                    </div>
                                    <i class="el-icon-arrow-right"></i>
                                </div>
                                <div v-if="userInfo.is_staff" class="menu-item" @click="goToAdminPage">
                                    <div class="menu-item-left">
                                        <i class="el-icon-key menu-icon"></i>
                                        <span>管理员后台</span>
                                    </div>
                                    <i class="el-icon-arrow-right"></i>
                                </div>
                                <div class="menu-item" @click="logout">
                                    <div class="menu-item-left">
                                        <i class="el-icon-switch-button menu-icon" style="color: #F56C6C;"></i>
                                        <span style="color: #F56C6C;">退出登录</span>
                                    </div>
                                    <i class="el-icon-arrow-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 底部导航 -->
            <div class="bottom-nav">
                <div 
                    class="nav-item" 
                    :class="{ active: currentTab === 'forum' }" 
                    @click="currentTab = 'forum'">
                    <i class="nav-icon el-icon-chat-line-square"></i>
                    <span>论坛</span>
                </div>
                <div 
                    class="nav-item" 
                    :class="{ active: currentTab === 'checkin' }" 
                    @click="currentTab = 'checkin'">
                    <i class="nav-icon el-icon-date"></i>
                    <span>打卡</span>
                </div>
                <div 
                    class="nav-item" 
                    :class="{ active: currentTab === 'tasks' }" 
                    @click="currentTab = 'tasks'">
                    <i class="nav-icon el-icon-s-data"></i>
                    <span>动态</span>
                </div>
                <div 
                    class="nav-item" 
                    :class="{ active: currentTab === 'profile' }" 
                    @click="currentTab = 'profile'">
                    <i class="nav-icon el-icon-user"></i>
                    <span>我的</span>
                </div>
            </div>
            
            <!-- 对话框 -->
            <el-dialog 
                :title="dialogTitle" 
                :visible.sync="dialogVisible"
                width="90%">
                <div v-if="dialogType === 'profile'">
                    <el-form label-width="80px">
                        <el-form-item label="用户名">
                            <el-input v-model="userInfo.username" disabled></el-input>
                        </el-form-item>
                        <el-form-item label="邮箱">
                            <el-input v-model="userInfo.email" disabled></el-input>
                        </el-form-item>
                        <el-form-item label="手机号" v-if="userInfo.phone">
                            <el-input v-model="userInfo.phone" disabled></el-input>
                        </el-form-item>
                    </el-form>
                </div>
                <div v-else-if="dialogType === 'security'">
                    <div style="padding: 10px 0;">
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-message menu-icon"></i>
                                <div>
                                    <div>邮箱绑定</div>
                                    <div style="font-size: 12px; color: #999;">{{ userInfo.email || '未绑定' }}</div>
                                </div>
                            </div>
                            <el-button size="mini" type="text" @click="changeEmail">{{ userInfo.email ? '更换' : '绑定' }}</el-button>
                        </div>
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-mobile-phone menu-icon"></i>
                                <div>
                                    <div>手机绑定</div>
                                    <div style="font-size: 12px; color: #999;">{{ userInfo.phone || '未绑定' }}</div>
                                </div>
                            </div>
                            <el-button size="mini" type="text">{{ userInfo.phone ? '更换' : '绑定' }}</el-button>
                        </div>
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-key menu-icon"></i>
                                <div>修改密码</div>
                            </div>
                            <el-button size="mini" type="text">修改</el-button>
                        </div>
                    </div>
                </div>
                <div v-else-if="dialogType === 'settings'">
                    <div style="padding: 10px 0;">
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-bell menu-icon"></i>
                                <span>消息通知</span>
                            </div>
                            <el-switch v-model="settings.notifications"></el-switch>
                        </div>
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-moon menu-icon"></i>
                                <span>深色模式</span>
                            </div>
                            <el-switch v-model="settings.darkMode" @change="toggleDarkMode"></el-switch>
                        </div>
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-document menu-icon"></i>
                                <span>隐私政策</span>
                            </div>
                            <i class="el-icon-arrow-right"></i>
                        </div>
                        <div class="menu-item">
                            <div class="menu-item-left">
                                <i class="el-icon-question menu-icon"></i>
                                <span>关于我们</span>
                            </div>
                            <i class="el-icon-arrow-right"></i>
                        </div>
                    </div>
                </div>
                <div v-else-if="dialogType === 'task'">
                    <el-form :model="newTask" label-width="80px">
                        <el-form-item label="任务名称" required>
                            <el-input v-model="newTask.title" placeholder="请输入任务名称"></el-input>
                        </el-form-item>

                        <el-form-item label="时间要求">
                            <el-input v-model="newTask.time" placeholder="如：每天早上8点"></el-input>
                        </el-form-item>
                        <!-- 目标时长 -->
                        <el-form-item label="目标时长">
                            <el-input-number 
                                v-model="newTask.target_duration" 
                                :min="0" 
                                :max="480"
                                style="width: 100%;"
                                placeholder="分钟">
                            </el-input-number>
                            <span style="color: #999; font-size: 12px; margin-left: 10px;">分钟（设置为0表示手动打卡）</span>
                        </el-form-item>
                        <el-form-item label="任务描述">
                            <el-input 
                                type="textarea" 
                                v-model="newTask.description" 
                                placeholder="请输入任务描述"
                                :rows="3"></el-input>
                        </el-form-item>
                    </el-form>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="dialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="createTask">创 建</el-button>
                    </span>
                </div>
                <div v-else-if="dialogType === 'changeEmail'">
                    <el-form :model="emailForm" label-width="80px">
                        <el-form-item label="原邮箱" required>
                            <el-input v-model="userInfo.email" disabled></el-input>
                        </el-form-item>
                        <el-form-item label="验证码" required>
                            <div style="display: flex;">
                                <el-input v-model="emailForm.oldCode" placeholder="请输入验证码"></el-input>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    style="margin-left: 10px; width: 120px;" 
                                    :disabled="oldCodeSending"
                                    @click="sendOldEmailCode">
                                    {{ oldCodeSending ? `${oldCodeTimer}s` : '获取验证码' }}
                                </el-button>
                            </div>
                        </el-form-item>
                        <el-form-item label="新邮箱" required>
                            <el-input v-model="emailForm.newEmail" placeholder="请输入新邮箱"></el-input>
                        </el-form-item>
                        <el-form-item label="验证码" required>
                            <div style="display: flex;">
                                <el-input v-model="emailForm.newCode" placeholder="请输入验证码"></el-input>
                                <el-button 
                                    type="primary" 
                                    size="small" 
                                    style="margin-left: 10px; width: 120px;" 
                                    :disabled="newCodeSending || !emailForm.newEmail"
                                    @click="sendNewEmailCode">
                                    {{ newCodeSending ? `${newCodeTimer}s` : '获取验证码' }}
                                </el-button>
                            </div>
                        </el-form-item>
                    </el-form>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="dialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="updateEmail">确 认</el-button>
                    </span>
                </div>
                <div v-else-if="dialogType === 'post'">
                    <el-form :model="newPost" label-width="80px">
                        <el-form-item label="标题" required>
                            <el-input v-model="newPost.title" placeholder="请输入帖子标题"></el-input>
                        </el-form-item>
                        <el-form-item label="内容" required>
                            <el-input 
                                type="textarea" 
                                v-model="newPost.content" 
                                placeholder="请输入帖子内容"
                                :rows="5"></el-input>
                        </el-form-item>
                    </el-form>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="dialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="createPost">发 布</el-button>
                    </span>
                </div>
                <!-- 专注相关对话框已删除 -->
            </el-dialog>
            
            <!-- 评论对话框 -->
            <el-dialog
                title="评论"
                :visible.sync="commentsDialogVisible"
                width="90%"
                max-width="600px"
                :close-on-click-modal="false">
                
                <div v-if="currentPost" class="comments-container">
                    <!-- 帖子信息 -->
                    <div class="post-info">
                        <h3>{{ currentPost.title }}</h3>
                        <p class="post-author">{{ currentPost.author }} · {{ currentPost.time }}</p>
                    </div>
                    
                    <!-- 发表评论 -->
                    <div class="comment-form" v-if="isLoggedIn">
                        <el-input
                            type="textarea"
                            v-model="newComment.content"
                            placeholder="写下你的评论..."
                            :rows="3"
                            maxlength="1000"
                            show-word-limit>
                        </el-input>
                        <div class="form-actions">
                            <el-button
                                type="primary"
                                size="small"
                                @click="submitComment"
                                :disabled="!newComment.content.trim()">
                                发表评论
                            </el-button>
                            <el-button
                                v-if="newComment.parent_id"
                                size="small"
                                @click="newComment.parent_id = null">
                                取消回复
                            </el-button>
                        </div>
                    </div>
                    
                    <div v-else class="login-prompt">
                        <p>请登录后发表评论</p>
                    </div>
                    
                    <!-- 评论列表 -->
                    <div class="comments-list">
                        <div v-if="commentsLoading" class="loading">
                            <i class="el-icon-loading"></i> 加载中...
                        </div>
                        
                        <div v-else-if="comments.length === 0" class="no-comments">
                            <p>还没有评论，快来抢沙发吧！</p>
                        </div>
                        
                        <div v-else>
                            <div class="comment-item" v-for="comment in comments" :key="comment.id">
                                <div class="comment-header">
                                    <span class="comment-author">{{ comment.username }}</span>
                                    <span class="comment-time">{{ comment.created_at }}</span>
                                </div>
                                <div class="comment-content">{{ comment.content }}</div>
                                <div class="comment-actions">
                                    <el-button 
                                        type="text" 
                                        size="mini"
                                        @click="replyToComment(comment)"
                                        v-if="isLoggedIn">
                                        回复
                                    </el-button>
                                    <el-button 
                                        type="text" 
                                        size="mini"
                                        @click="deleteComment(comment)"
                                        v-if="comment.is_author || (userInfo && userInfo.is_staff)">
                                        删除
                                    </el-button>
                                </div>
                                
                                <!-- 回复列表 -->
                                <div class="replies" v-if="comment.replies && comment.replies.length > 0">
                                    <div class="reply-item" v-for="reply in comment.replies" :key="reply.id">
                                        <div class="comment-header">
                                            <span class="comment-author">{{ reply.username }}</span>
                                            <span class="comment-time">{{ reply.created_at }}</span>
                                        </div>
                                        <div class="comment-content">{{ reply.content }}</div>
                                        <div class="comment-actions">
                                            <el-button 
                                                type="text" 
                                                size="mini"
                                                @click="deleteComment(reply)"
                                                v-if="reply.is_author || (userInfo && userInfo.is_staff)">
                                                删除
                                            </el-button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </el-dialog>
            
            <!-- 完成弹窗 -->
            <el-dialog 
                :title="completionType === 'study' ? '学习完成' : '运动完成'" 
                :visible.sync="completionDialogVisible"
                width="90%"
                :close-on-click-modal="false">
                
                <!-- 学习完成 -->
                <div v-if="completionType === 'study' && completionData">
                    <div style="text-align: center; padding: 20px;">
                        <i class="el-icon-circle-check" style="font-size: 60px; color: #67C23A;"></i>
                        <h2 style="margin: 20px 0;">{{ completionData.title }}</h2>
                        <div style="font-size: 18px; margin: 10px 0;">
                            学习时长：{{ formatStudyTime(completionData.duration) }}
                        </div>
                        <div v-if="completionData.targetDuration > 0" style="color: #999;">
                            目标时长：{{ completionData.targetDuration }}分钟
                        </div>
                    </div>
                </div>
                
                <!-- 运动完成 -->
                <div v-else-if="completionType === 'sport' && completionData">
                    <div style="text-align: center; padding: 20px;">
                        <i class="el-icon-circle-check" style="font-size: 60px; color: #67C23A;"></i>
                        <h2 style="margin: 20px 0;">{{ completionData.title }}</h2>
                        <div style="display: flex; justify-content: center; margin: 20px 0;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">{{ formatStudyTime(completionData.duration) }}</div>
                                <div style="color: #999;">运动时长</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 分享选项 -->
                <div style="margin-top: 20px;">
                    <el-divider>分享到社区</el-divider>
                    <el-input 
                        type="textarea" 
                        v-model="shareNotes" 
                        placeholder="写下你的感想..."
                        :rows="3"
                        maxlength="200"
                        show-word-limit>
                    </el-input>
                </div>
                
                <span slot="footer" class="dialog-footer">
                    <el-button @click="closeCompletionDialog">稍后再说</el-button>
                    <el-button type="primary" @click="shareToCommunit">分享到社区</el-button>
                </span>
            </el-dialog>
        </div>
    </div>

    <!-- 整合的JavaScript脚本 -->
    <script>
        // 添加调试功能
        console.originalLog = console.log;
        console.log = function() {
            console.originalLog.apply(console, arguments);
            var message = Array.prototype.slice.call(arguments).join(' ');
            var debugLog = document.getElementById('debug-log');
            if (debugLog) {
                var p = document.createElement('p');
                p.textContent = message;
                debugLog.appendChild(p);
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        };
        
        // 确保静态内容显示，直到Vue加载完成
        var staticContent = document.getElementById('static-content');
        if (staticContent) {
            staticContent.style.display = 'block';
        }
        
        // DOMContentLoaded事件后初始化Vue
        document.addEventListener('DOMContentLoaded', function() {
            // 创建Vue实例
            window.vueApp = new Vue({
                el: '#app',
                data: {
                    initialized: false,
                    loading: false,
                    isLoggedIn: false,
                    userInfo: { username: '游客用户', email: '未登录' },
                    currentTab: 'checkin',
                    selectedSchool: { id: null, name: '请选择学校' },
                    schools: [],
                    dialogVisible: false,
                    dialogType: '',
                    dialogTitle: '',
                    settings: {
                        notifications: true,
                        darkMode: false
                    },
                    posts: [],
                    checkins: [],
                    communityCheckins: [],
                    activeTab: 'tasks',
                    // 分页相关数据
                    pagination: {
                        page: 1,
                        pageSize: 10,
                        total: 0,
                        totalPages: 1,
                        hasNext: false,
                        hasPrev: false
                    },
                    paginationLoading: false,
                    // 搜索相关数据
                    search: {
                        isSearchMode: false,        // 是否在搜索模式
                        query: '',                  // 搜索关键词
                        results: [],               // 搜索结果
                        pagination: {              // 搜索分页信息
                            page: 1,
                            pageSize: 10,
                            total: 0,
                            totalPages: 1,
                            hasNext: false,
                            hasPrev: false
                        },
                        loading: false,            // 搜索加载状态
                        searchTime: '',            // 搜索用时
                        totalFound: 0,             // 搜索结果总数
                        history: []                // 搜索历史
                    },
                    searchInputTimer: null,        // 搜索防抖计时器
                    newTask: {
                        title: '',
                        time: '',
                        description: '',
                        target_duration: 0
                    },
                    emailForm: {
                        oldCode: '',
                        newEmail: '',
                        newCode: ''
                    },
                    oldCodeSending: false,
                    oldCodeTimer: 60,
                    newCodeSending: false,
                    newCodeTimer: 60,
                    newPost: {
                        title: '',
                        content: ''
                    },
                    userPosts: [],
                    // 专注模式相关数据已删除
                    // 评论相关数据
                    commentsDialogVisible: false,
                    currentPost: null,
                    comments: [],
                    newComment: {
                        content: '',
                        parent_id: null
                    },
                    commentsLoading: false,
                    // 学习和运动追踪器
                    studyTimers: {},
                    sportTrackers: {},
                    // 完成弹窗相关
                    completionDialogVisible: false,
                    completionType: '',
                    completionData: {},
                    shareNotes: '',
                    currentCheckinRecordId: null,
                    communityPagination: {
                        page: 1,
                        pageSize: 10,
                        total: 0,
                        totalPages: 1,
                        hasNext: false,
                        hasPrev: false
                    },
                    communityLoading: false,
                    userPostsPagination: {
                        page: 1,
                        pageSize: 10,
                        total: 0,
                        totalPages: 1,
                        hasNext: false,
                        hasPrev: false
                    },
                    userPostsLoading: false
                },
                computed: {
                    avatarInitial() {
                        return this.userInfo.username ? this.userInfo.username[0].toUpperCase() : '?';
                    },
                    displayUsername() {
                        return this.userInfo.username || '用户';
                    },
                    filteredPosts() {
                        // 如果是搜索模式，返回搜索结果；否则返回热门帖子
                        return this.search.isSearchMode ? this.search.results : this.posts;
                    },
                    currentPagination() {
                        // 根据当前模式返回相应的分页信息
                        return this.search.isSearchMode ? this.search.pagination : this.pagination;
                    },
                    filteredCheckins() {
                        // 后端API已经按学校过滤，无需再次过滤
                        return this.checkins;
                    }
                },
                watch: {
                    currentTab(newTab, oldTab) {
                        // 保存当前tab状态（用于返回时恢复）
                        if (newTab && ['forum', 'checkin', 'tasks'].includes(newTab)) {
                            localStorage.setItem('lastActiveTab', newTab);
                        }
                        
                        // 先显示加载状态
                        this.loading = true;
                        
                        // 当切换到论坛标签时，加载论坛数据
                        if (newTab === 'forum' && this.selectedSchool.id) {
                            this.fetchForumData();
                            if (this.isLoggedIn) {
                                this.fetchUserPosts(1);
                            }
                        }
                        // 当切换到打卡标签时，加载打卡数据
                        else if (newTab === 'checkin') {
                            this.refreshCheckins();
                        }
                        // 当切换到动态标签时，加载动态数据
                        else if (newTab === 'tasks') {
                            this.refreshCommunity();
                        } else {
                            // 如果是其他标签（如个人中心），直接关闭加载状态，但添加短暂延迟
                            setTimeout(() => {
                                this.loading = false;
                            }, 200);
                        }
                    }
                },
                methods: {
                    fetchSchools() {
                        this.loading = true;
                        axios.get('/forum/api/schools/')
                            .then(response => {
                                this.schools = response.data;
                                if (this.schools.length > 0 && !this.selectedSchool.id) {
                                    this.selectedSchool = this.schools[0];
                                }
                                this.loading = false;
                                // 获取初始学校的数据
                                this.fetchSchoolData();
                            })
                            .catch(error => {
                                console.error('获取学校列表失败:', error);
                                this.loading = false;
                                this.$message.error('获取学校数据失败，请刷新页面重试');
                            });
                    },
                    fetchSchoolData() {
                        if (!this.selectedSchool.id) return;
                        
                        this.loading = true;
                        // 根据当前标签加载相应数据
                        if (this.currentTab === 'forum') {
                            this.fetchForumData();
                        } else {
                            // 并行请求打卡和社区数据
                            Promise.all([
                                axios.get(`/checkin/checkins/`),
                                axios.get('/checkin/community/')
                            ])
                            .then(([checkinsResponse, communityResponse]) => {
                                this.checkins = checkinsResponse.data;
                                this.communityCheckins = communityResponse.data;
                                this.loading = false;
                            })
                            .catch(error => {
                                console.error('获取数据失败:', error);
                                this.loading = false;
                                this.$message.error('获取数据失败，请刷新页面重试');
                            });
                        }
                    },
                    changeSchool(schoolId) {
                        const school = this.schools.find(s => s.id === schoolId);
                        if (school) {
                            this.selectedSchool = school;
                            // 切换学校后重新获取论坛数据
                            if (this.currentTab === 'forum') {
                                this.fetchForumData();
                            }
                        }
                    },
                    showProfile() {
                        this.dialogType = 'profile';
                        this.dialogTitle = '个人资料';
                        this.dialogVisible = true;
                    },
                    changeEmail() {
                        this.dialogType = 'changeEmail';
                        this.dialogTitle = '更换邮箱';
                        this.dialogVisible = true;
                    },
                    showSecurity() {
                        this.dialogType = 'security';
                        this.dialogTitle = '安全中心';
                        this.dialogVisible = true;
                    },
                    showSettings() {
                        this.dialogType = 'settings';
                        this.dialogTitle = '设置';
                        this.dialogVisible = true;
                    },
                    logout() {
                        // 清除localStorage中的数据
                        localStorage.removeItem('user');
                        localStorage.removeItem('token');
                        
                        // 清除axios默认请求头
                        delete axios.defaults.headers.common['Authorization'];
                        
                        // 清除cookie中的token
                        document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                        
                        this.$message.success('已退出登录');
                        setTimeout(() => { window.location.href = '/accounts/auth/'; }, 500);
                    },
                    doCheckin(checkin) {
                        // 如果已经打卡且有保存的进度，恢复进度
                        if (checkin.checked_today && this.hasProgressInStorage(checkin)) {
                            this.restoreStudyProgress(checkin);
                            return;
                        }
                        
                        // 如果设置了目标时长，开始计时打卡
                        if (checkin.target_duration > 0) {
                            this.startTimerCheckin(checkin);
                        } else {
                            // 手动打卡
                            this.normalCheckin(checkin);
                        }
                    },
                    
                    // 普通打卡
                    normalCheckin(checkin) {
                        this.loading = true;
                        axios.post(`/checkin/checkins/${checkin.id}/check/`)
                            .then(response => {
                                // 更新本地打卡状态
                                const index = this.checkins.findIndex(c => c.id === checkin.id);
                                if (index !== -1) {
                                    this.checkins[index].checked_today = true;
                                    this.checkins[index].today_checkin_data = response.data.checkin_record;
                                    this.checkins[index].today_checkin_id = response.data.checkin_record.id;
                                    this.$message.success('打卡成功！');
                                }
                                
                                // 刷新社区动态
                                this.refreshCommunity();
                                this.loading = false;
                            })
                            .catch(error => {
                                console.error('打卡失败:', error);
                                this.loading = false;
                                if (error.response && error.response.data && error.response.data.error) {
                                    this.$message.error(error.response.data.error);
                                } else {
                                    this.$message.error('操作失败，请重试');
                                }
                            });
                    },
                    
                    // 计时打卡
                    startTimerCheckin(checkin) {
                        this.$confirm('开始打卡将启动计时器，确定开始吗？', '计时打卡', {
                            confirmButtonText: '开始计时',
                            cancelButtonText: '取消',
                            type: 'info'
                        }).then(() => {
                            this.loading = true;
                            axios.post(`/checkin/checkins/${checkin.id}/check/`)
                                .then(response => {
                                    const index = this.checkins.findIndex(c => c.id === checkin.id);
                                    if (index !== -1) {
                                        this.checkins[index].checked_today = true;
                                        this.checkins[index].today_checkin_data = response.data.checkin_record;
                                        this.checkins[index].today_checkin_id = response.data.checkin_record.id;
                                        
                                        // 开始计时
                                        this.startStudyTimer(this.checkins[index]);
                                        this.$message.success('计时打卡已开始，请专注任务！');
                                    }
                                    
                                    this.refreshCommunity();
                                    this.loading = false;
                                })
                                .catch(error => {
                                    console.error('打卡失败:', error);
                                    this.loading = false;
                                    if (error.response && error.response.data && error.response.data.error) {
                                        this.$message.error(error.response.data.error);
                                    } else {
                                        this.$message.error('操作失败，请重试');
                                    }
                                });
                        });
                    },
                    

                    refreshCheckins() {
                        // 重新获取打卡数据
                        this.loading = true;
                        axios.get(`/checkin/checkins/`)
                            .then(response => {
                                // 保存当前已清理的任务ID
                                const clearedTaskIds = new Set();
                                this.checkins.forEach(checkin => {
                                    if (!checkin.studyTimer && !checkin.active_session) {
                                        clearedTaskIds.add(checkin.id);
                                    }
                                });
                                
                                // 更新数据
                                this.checkins = response.data;
                                
                                // 确保已清理的任务不会恢复状态
                                this.checkins.forEach((checkin, index) => {
                                    if (clearedTaskIds.has(checkin.id)) {
                                        // 如果这个任务之前已经清理过状态，确保不显示active_session
                                        if (checkin.active_session) {
                                            const cleanCheckin = { ...checkin };
                                            delete cleanCheckin.active_session;
                                            delete cleanCheckin.studyTimer;
                                            this.$set(this.checkins, index, cleanCheckin);
                                        }
                                    }
                                });
                                
                                setTimeout(() => {
                                    this.loading = false;
                                }, 200); // 添加短暂延迟，确保动画平滑
                                this.$message.success('已刷新打卡列表');
                            })
                            .catch(error => {
                                console.error('刷新打卡列表失败:', error);
                                this.loading = false;
                                this.$message.error('刷新失败，请重试');
                            });
                    },
                    
                    // 刷新单个打卡任务数据
                    refreshSingleCheckin(checkinId) {
                        const index = this.checkins.findIndex(c => c.id === checkinId);
                        if (index !== -1) {
                            axios.get(`/checkin/checkins/`)
                                .then(response => {
                                    const updatedCheckin = response.data.find(c => c.id === checkinId);
                                    if (updatedCheckin) {
                                        this.$set(this.checkins, index, updatedCheckin);
                                    }
                                })
                                .catch(error => {
                                    console.error('刷新单个打卡任务失败:', error);
                                });
                        }
                    },
                    
                    // 运动状态通过数据库管理，不需要本地恢复
                    checkLoginStatus() {
                        const token = localStorage.getItem('token');
                        const user = localStorage.getItem('user');
                        
                        if (token && user) {
                            try {
                                this.userInfo = JSON.parse(user);
                                this.isLoggedIn = true;
                                
                                // 设置Authorization头
                                axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                                
                                // 另外在每个请求中添加X-Auth-Token，确保在某些环境能被正确拦截
                                axios.interceptors.request.use(config => {
                                    config.headers['X-Auth-Token'] = token;
                                    return config;
                                });
                                
                            } catch (e) {
                                console.error('解析用户信息失败:', e);
                                this.isLoggedIn = false;
                            }
                        } else {
                            this.isLoggedIn = false;
                            this.userInfo = { username: '游客用户', email: '未登录' };
                        }
                    },
                    
                    restoreTabState() {
                        // 检查URL hash
                        const hash = window.location.hash;
                        if (hash === '#forum') {
                            this.currentTab = 'forum';
                            // 清除hash，避免页面跳转
                            window.history.replaceState(null, null, window.location.pathname);
                            console.log('从URL hash恢复到论坛tab');
                            return;
                        }
                        
                        // 检查localStorage中的activeTab设置
                        const savedTab = localStorage.getItem('activeTab');
                        if (savedTab) {
                            // 恢复到指定的tab
                            if (savedTab === 'forum') {
                                this.currentTab = 'forum';
                                console.log('从localStorage恢复到论坛tab');
                            } else if (savedTab === 'checkin') {
                                this.currentTab = 'checkin';
                                console.log('从localStorage恢复到打卡tab');
                            } else if (savedTab === 'tasks') {
                                this.currentTab = 'tasks';
                                console.log('从localStorage恢复到动态tab');
                            }
                            
                            // 清除localStorage中的activeTab，避免影响正常使用
                            localStorage.removeItem('activeTab');
                        }
                    },
                    
                    // ===== 专注模式相关方法已删除 =====
                    fetchTasks() {
                        this.loading = true;
                        axios.get('/checkin/checkins/')
                            .then(response => {
                                this.checkins = response.data;
                                this.loading = false;
                            })
                            .catch(error => {
                                console.error('获取任务失败:', error);
                                this.loading = false;
                                this.$message.error('获取任务失败，请刷新页面重试');
                            });
                    },
                    createTask() {
                        if (!this.newTask.title) {
                            this.$message.error('任务名称不能为空');
                            return;
                        }
                        
                        this.loading = true;
                        axios.post('/checkin/checkins/create/', this.newTask)
                            .then(response => {
                                this.dialogVisible = false;
                                this.checkins.unshift(response.data.checkin);
                                this.$message.success('任务创建成功');
                                
                                // 重置表单
                                this.newTask = {
                                    title: '',
                                    time: '',
                                    description: '',
                                    target_duration: 0
                                };
                                
                                this.loading = false;
                            })
                            .catch(error => {
                                console.error('创建任务失败:', error);
                                this.loading = false;
                                this.$message.error('创建任务失败，请重试');
                            });
                    },
                    deleteCheckin(checkin) {
                        this.$confirm('确定要删除此任务吗?', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            this.loading = true;
                            axios.delete(`/checkin/checkins/${checkin.id}/delete/`)
                                .then(response => {
                                    const index = this.checkins.findIndex(c => c.id === checkin.id);
                                    if (index !== -1) {
                                        this.checkins.splice(index, 1);
                                    }
                                    this.$message.success('任务已删除');
                                    this.loading = false;
                                })
                                .catch(error => {
                                    console.error('删除任务失败:', error);
                                    this.loading = false;
                                    this.$message.error('删除失败，请重试');
                                });
                        }).catch(() => {
                            // 取消删除
                        });
                    },
                    loadUserData() {
                        this.loading = true;
                        Promise.all([
                            axios.get('/accounts/profile/'),
                            axios.get('/checkin/checkins/'),
                            axios.get('/checkin/community/')
                        ])
                        .then(([ profileResponse, checkinsResponse, communityResponse]) => {
                        
                            this.userInfo = profileResponse.data.data;
                            this.checkins = checkinsResponse.data;
                            this.communityCheckins = communityResponse.data;
                            
                            setTimeout(() => {
                                this.loading = false;
                            }, 200); // 添加短暂延迟，确保动画平滑
                        })
                        .catch(error => {
                            console.error('加载用户数据失败:', error);
                            this.loading = false;
                            
                            if (error.response && error.response.status === 401) {
                                // 未登录，重定向到登录页
                                this.isLoggedIn = false;
                            } else {
                                this.$message.error('加载用户数据失败，请刷新页面重试');
                            }
                        });
                    },
                    refreshCommunity() {
                        this.fetchCommunityData(1);
                        this.$message.success('正在刷新打卡动态');
                    },
                    
                    fetchCommunityData(page = 1) {
                        this.communityLoading = true;
                        if (page === 1) {
                            this.loading = true;
                        }
                        
                        axios.get(`/checkin/community/?page=${page}&page_size=${this.communityPagination.pageSize}`)
                            .then(response => {
                                this.communityCheckins = response.data.checkins;
                                this.communityPagination = {
                                    ...this.communityPagination,
                                    page: response.data.pagination.page,
                                    total: response.data.pagination.total,
                                    totalPages: response.data.pagination.total_pages,
                                    hasNext: response.data.pagination.has_next,
                                    hasPrev: response.data.pagination.has_prev
                                };
                                
                                setTimeout(() => {
                                    this.loading = false;
                                    this.communityLoading = false;
                                }, 200); // 添加短暂延迟，确保动画平滑
                            })
                            .catch(error => {
                                console.error('获取打卡动态失败:', error);
                                this.loading = false;
                                this.communityLoading = false;
                                this.$message.error('获取打卡动态失败，请重试');
                            });
                    },
                    
                    handleCommunityPageChange(page) {
                        this.fetchCommunityData(page);
                        // 滚动到页面顶部
                        document.querySelector('.content-area').scrollTop = 0;
                    },
                    
                    handleCommunityPageSizeChange(pageSize) {
                        this.communityPagination.pageSize = pageSize;
                        this.communityPagination.page = 1;
                        this.fetchCommunityData(1);
                    },
                    
                    // 学习计时相关方法
                    startStudyTimer(checkin) {
                        // 存储当前学习任务
                        if (!this.studyTimers) {
                            this.studyTimers = {};
                        }
                        
                        const startTime = new Date().getTime();
                        this.studyTimers[checkin.id] = {
                            startTime: startTime,
                            duration: 0,
                            isPaused: false,
                            pausedDuration: 0, // 累计暂停的时长
                            lastPauseTime: null,
                            interval: null
                        };
                        
                        // 开始计时
                        this.studyTimers[checkin.id].interval = setInterval(() => {
                            if (!this.studyTimers[checkin.id].isPaused) {
                                const currentTime = new Date().getTime();
                                const totalElapsed = currentTime - startTime - this.studyTimers[checkin.id].pausedDuration;
                                const duration = Math.floor(totalElapsed / 1000);
                                this.studyTimers[checkin.id].duration = duration;
                                
                                // 使用 Vue.set 确保响应式更新
                                if (checkin.studyTimer) {
                                    this.$set(checkin.studyTimer, 'duration', duration);
                                }
                                
                                // 每30秒更新一次服务器
                                if (duration % 30 === 0 && duration > 0) {
                                    this.updateStudyDuration(checkin, duration);
                                }
                                
                                // 自动检查是否达到目标时长
                                if (checkin.target_duration > 0 && duration >= checkin.target_duration * 60) {
                                    // 达到目标时长，但不自动停止，只是提示
                                    if (!checkin.studyTimer.hasReachedTarget) {
                                        this.$set(checkin.studyTimer, 'hasReachedTarget', true);
                                        this.$message.success('恭喜！您已达到目标学习时长，可以继续学习或完成打卡');
                                    }
                                }
                            }
                        }, 1000);
                        
                        // 在任务对象上添加计时器引用，使用 Vue.set 确保响应式
                        this.$set(checkin, 'studyTimer', this.studyTimers[checkin.id]);
                        
                        // 保存到localStorage，防止刷新丢失
                        this.saveStudyProgress(checkin.id);
                    },
                    
                    // 暂停学习计时
                    pauseStudyTimer(checkin) {
                        if (this.studyTimers && this.studyTimers[checkin.id]) {
                            const timer = this.studyTimers[checkin.id];
                            timer.isPaused = true;
                            timer.lastPauseTime = new Date().getTime();
                            
                            if (checkin.studyTimer) {
                                this.$set(checkin.studyTimer, 'isPaused', true);
                            }
                            
                            this.$message.info('学习已暂停');
                            this.saveStudyProgress(checkin.id);
                        }
                    },
                    
                    // 继续学习计时
                    resumeStudyTimer(checkin) {
                        if (this.studyTimers && this.studyTimers[checkin.id]) {
                            const timer = this.studyTimers[checkin.id];
                            if (timer.isPaused && timer.lastPauseTime) {
                                // 计算暂停的时长
                                const pauseDuration = new Date().getTime() - timer.lastPauseTime;
                                timer.pausedDuration += pauseDuration;
                                timer.isPaused = false;
                                timer.lastPauseTime = null;
                                
                                if (checkin.studyTimer) {
                                    this.$set(checkin.studyTimer, 'isPaused', false);
                                }
                                
                                this.$message.success('继续学习');
                                this.saveStudyProgress(checkin.id);
                            }
                        }
                    },
                    
                    stopStudyTimer(checkin) {
                        if (this.studyTimers && this.studyTimers[checkin.id]) {
                            const timer = this.studyTimers[checkin.id];
                            const duration = timer.duration;
                            
                            // 1. 立即停止计时器
                            if (timer.interval) {
                                clearInterval(timer.interval);
                            }
                            
                            // 2. 立即清除所有本地状态
                            delete this.studyTimers[checkin.id];
                            if (checkin.studyTimer) {
                                this.$delete(checkin, 'studyTimer');
                            }
                            this.removeStudyProgress(checkin.id);
                            
                            // 3. 立即更新checkin对象，确保UI显示"已完成"状态
                            if (checkin.today_checkin_data) {
                                this.$set(checkin.today_checkin_data, 'duration', duration);
                                this.$set(checkin.today_checkin_data, 'end_time', new Date().toISOString());
                            }
                            
                            // 4. 清除active_session，防止显示进行中状态
                            if (checkin.active_session) {
                                this.$delete(checkin, 'active_session');
                            }
                            
                            // 5. 强制更新组件
                            this.$forceUpdate();
                            
                            // 5. 最后更新服务器（不影响UI显示）
                            this.updateStudyDuration(checkin, duration, true);
                        }
                    },
                    
                    // 保存学习进度到localStorage
                    saveStudyProgress(checkinId) {
                        if (this.studyTimers && this.studyTimers[checkinId]) {
                            const timer = this.studyTimers[checkinId];
                            const progressData = {
                                startTime: timer.startTime,
                                duration: timer.duration,
                                isPaused: timer.isPaused,
                                pausedDuration: timer.pausedDuration,
                                lastPauseTime: timer.lastPauseTime,
                                savedAt: new Date().getTime()
                            };
                            localStorage.setItem(`study_progress_${checkinId}`, JSON.stringify(progressData));
                        }
                    },
                    
                    // 从localStorage恢复学习进度
                    restoreStudyProgress(checkin) {
                        const progressData = localStorage.getItem(`study_progress_${checkin.id}`);
                        if (progressData) {
                            try {
                                const data = JSON.parse(progressData);
                                const now = new Date().getTime();
                                
                                // 如果保存时间超过24小时，则清除数据
                                if (now - data.savedAt > 24 * 60 * 60 * 1000) {
                                    this.removeStudyProgress(checkin.id);
                                    return false;
                                }
                                
                                // 恢复计时器
                                if (!this.studyTimers) {
                                    this.studyTimers = {};
                                }
                                
                                this.studyTimers[checkin.id] = {
                                    startTime: data.startTime,
                                    duration: data.duration,
                                    isPaused: data.isPaused,
                                    pausedDuration: data.pausedDuration,
                                    lastPauseTime: data.lastPauseTime,
                                    interval: null
                                };
                                
                                // 如果当前是暂停状态，需要更新暂停时长
                                if (data.isPaused && data.lastPauseTime) {
                                    const additionalPauseDuration = now - data.savedAt;
                                    this.studyTimers[checkin.id].pausedDuration += additionalPauseDuration;
                                }
                                
                                // 重新启动计时器
                                this.studyTimers[checkin.id].interval = setInterval(() => {
                                    if (!this.studyTimers[checkin.id].isPaused) {
                                        const currentTime = new Date().getTime();
                                        const totalElapsed = currentTime - this.studyTimers[checkin.id].startTime - this.studyTimers[checkin.id].pausedDuration;
                                        const duration = Math.floor(totalElapsed / 1000);
                                        this.studyTimers[checkin.id].duration = duration;
                                        
                                        // 使用 Vue.set 确保响应式更新
                                        if (checkin.studyTimer) {
                                            this.$set(checkin.studyTimer, 'duration', duration);
                                        }
                                        
                                        // 每30秒更新一次服务器
                                        if (duration % 30 === 0 && duration > 0) {
                                            this.updateStudyDuration(checkin, duration);
                                        }
                                        
                                        // 自动检查是否达到目标时长
                                        if (checkin.target_duration > 0 && duration >= checkin.target_duration * 60) {
                                            if (!checkin.studyTimer.hasReachedTarget) {
                                                this.$set(checkin.studyTimer, 'hasReachedTarget', true);
                                                this.$message.success('恭喜！您已达到目标学习时长，可以继续学习或完成打卡');
                                            }
                                        }
                                    }
                                }, 1000);
                                
                                // 在任务对象上添加计时器引用
                                this.$set(checkin, 'studyTimer', this.studyTimers[checkin.id]);
                                
                                this.$message.success('已恢复学习进度');
                                return true;
                            } catch (error) {
                                console.error('恢复学习进度失败:', error);
                                this.removeStudyProgress(checkin.id);
                                return false;
                            }
                        }
                        return false;
                    },
                    
                    // 移除学习进度
                    removeStudyProgress(checkinId) {
                        localStorage.removeItem(`study_progress_${checkinId}`);
                    },
                    
                    // 恢复所有学习进度
                    restoreAllStudyProgress() {
                        console.log('开始恢复学习进度...');
                        if (this.checkins && this.checkins.length > 0) {
                            this.checkins.forEach(checkin => {
                                console.log('检查任务:', checkin.title, {
                                    checked_today: checkin.checked_today,
                                    target_duration: checkin.target_duration,
                                    active_session: checkin.active_session,
                                    studyTimer: checkin.studyTimer,
                                    hasProgress: this.hasProgressInStorage(checkin),
                                    today_checkin_data: checkin.today_checkin_data
                                });
                                
                                // 只恢复今天已打卡、有目标时长、没有活跃会话且没有计时器的任务
                                // 并且今天的打卡数据没有end_time（说明还没完成）
                                if (checkin.checked_today && 
                                    checkin.target_duration > 0 && 
                                    !checkin.active_session && 
                                    !checkin.studyTimer &&
                                    this.hasProgressInStorage(checkin) &&
                                    checkin.today_checkin_data &&
                                    !checkin.today_checkin_data.end_time) {
                                    console.log('恢复进度:', checkin.title);
                                    this.restoreStudyProgress(checkin);
                                } else if (this.hasProgressInStorage(checkin) && 
                                          checkin.today_checkin_data && 
                                          checkin.today_checkin_data.end_time) {
                                    // 如果任务已完成但localStorage还有数据，清理它
                                    console.log('清理已完成任务的进度:', checkin.title);
                                    this.removeStudyProgress(checkin.id);
                                }
                            });
                        }
                    },
                    
                    // 检查是否有进度保存在localStorage中
                    hasProgressInStorage(checkin) {
                        if (checkin.target_duration > 0) {
                            return localStorage.getItem(`study_progress_${checkin.id}`) !== null;
                        }
                        return false;
                    },
                    
                    // 获取打卡按钮文本
                    getCheckinButtonText(checkin) {
                        if (checkin.checked_today) {
                            if (this.hasProgressInStorage(checkin)) {
                                return '恢复进度';
                            } else {
                                return '今日已打卡';
                            }
                        } else {
                            return '打卡';
                        }
                    },
                    
                    updateStudyDuration(checkin, duration, isEnd = false) {
                        axios.post(`/checkin/checkins/${checkin.id}/study/update/`, {
                            duration: duration,
                            is_end: isEnd
                        })
                        .then(response => {
                            if (isEnd) {
                                // 确保清理localStorage
                                this.removeStudyProgress(checkin.id);
                                
                                // 显示完成弹窗
                                this.showCompletionDialog('timer', {
                                    title: checkin.title,
                                    duration: duration,
                                    targetDuration: checkin.target_duration
                                }, response.data.checkin_record.id, checkin);
                                
                                // 暂时不刷新，避免状态被恢复
                                // this.refreshCheckins();
                            }
                        })
                        .catch(error => {
                            console.error('更新学习时长失败:', error);
                        });
                    },
                    
                    formatStudyTime(seconds) {
                        // 确保seconds是一个有效的数字
                        seconds = parseInt(seconds) || 0;
                        
                        const hours = Math.floor(seconds / 3600);
                        const minutes = Math.floor((seconds % 3600) / 60);
                        const secs = seconds % 60;
                        
                        if (hours > 0) {
                            return `${hours}小时${minutes}分钟${secs}秒`;
                        } else if (minutes > 0) {
                            return `${minutes}分钟${secs}秒`;
                        } else {
                            return `${secs}秒`;
                        }
                    },
                    
                    // 运动类任务使用数据库管理状态，不需要本地追踪
                    
                    // 暂停运动
                    pauseSportTracking(checkin) {
                        axios.post(`/checkin/checkins/${checkin.id}/session/pause/`)
                            .then(response => {
                                // 刷新数据
                                this.refreshCheckins();
                                this.$message.info('运动已暂停');
                            })
                            .catch(error => {
                                console.error('暂停运动失败:', error);
                                this.$message.error('暂停失败，请重试');
                            });
                    },
                    
                    // 继续运动
                    resumeSportTracking(checkin) {
                        axios.post(`/checkin/checkins/${checkin.id}/session/resume/`)
                            .then(response => {
                                // 刷新数据
                                this.refreshCheckins();
                                this.$message.success('继续运动');
                            })
                            .catch(error => {
                                console.error('继续运动失败:', error);
                                this.$message.error('继续失败，请重试');
                            });
                    },
                    
                    // 启动本地运动追踪（用于恢复或继续）

                    

                    
                    stopSportTracking(checkin) {
                        // 结束运动会话
                        axios.post(`/checkin/checkins/${checkin.id}/session/end/`)
                        .then(response => {
                            // 显示完成弹窗
                            const checkinRecord = response.data.checkin_record;
                            this.showCompletionDialog('timer', {
                                title: checkin.title,
                                duration: checkinRecord.duration
                            }, checkinRecord.id, checkin);
                            
                            // 暂时不刷新，避免状态被恢复
                            // this.refreshCheckins();
                        })
                        .catch(error => {
                            console.error('结束运动失败:', error);
                            this.$message.error('结束运动失败，请重试');
                        });
                    },
                    

                    

                    

                    

                    
                    // 显示完成弹窗
                    showCompletionDialog(type, data, checkinRecordId, checkin = null) {
                        this.completionData = data;
                        this.completionType = type;
                        this.currentCheckinRecordId = checkinRecordId;
                        this.completionDialogVisible = true;
                        
                        // 状态清理已经在stopStudyTimer/stopSportTracking中完成
                        console.log('显示完成弹窗，记录ID:', checkinRecordId);
                    },
                    

                    
                    // 分享到社区
                    shareToCommunit() {
                        if (!this.currentCheckinRecordId) {
                            this.$message.error('找不到打卡记录');
                            return;
                        }
                        
                        const notes = this.shareNotes || '';
                        
                        // 调用API分享到社区
                        axios.post(`/checkin/checkins/records/${this.currentCheckinRecordId}/share/`, {
                            notes: notes
                        })
                        .then(response => {
                            this.$message.success('已分享到社区！');
                            this.completionDialogVisible = false;
                            this.shareNotes = '';
                            
                            // 确保清理所有可能的计时器状态
                            if (this.currentCheckinRecordId) {
                                // 遍历所有checkins，清理匹配的任务状态
                                this.checkins.forEach((checkin, index) => {
                                    if (checkin.today_checkin_id === this.currentCheckinRecordId || 
                                        (checkin.today_checkin_data && checkin.today_checkin_data.id === this.currentCheckinRecordId)) {
                                        
                                        // 清理计时器
                                        if (this.studyTimers && this.studyTimers[checkin.id]) {
                                            const timer = this.studyTimers[checkin.id];
                                            if (timer.interval) {
                                                clearInterval(timer.interval);
                                            }
                                            delete this.studyTimers[checkin.id];
                                        }
                                        
                                        // 创建一个新的checkin对象，确保没有studyTimer属性
                                        const cleanCheckin = { ...checkin };
                                        delete cleanCheckin.studyTimer;
                                        delete cleanCheckin.active_session;
                                        
                                        // 使用Vue.set更新数组元素
                                        this.$set(this.checkins, index, cleanCheckin);
                                        
                                        // 清理localStorage中的进度
                                        this.removeStudyProgress(checkin.id);
                                    }
                                });
                            }
                            
                            this.currentCheckinRecordId = null;
                            
                            // 延迟刷新，确保状态已经清理
                            setTimeout(() => {
                                this.refreshCheckins();
                                this.refreshCommunity();
                            }, 100);
                        })
                        .catch(error => {
                            console.error('分享失败:', error);
                                                         this.$message.error(error.response?.data?.error || '分享失败，请重试');
                         });
                    },
                    
                    // 关闭完成弹窗
                    closeCompletionDialog() {
                        this.completionDialogVisible = false;
                        this.shareNotes = '';
                        
                        // 确保清理所有可能的计时器状态
                        if (this.currentCheckinRecordId) {
                            // 遍历所有checkins，清理匹配的任务状态
                            this.checkins.forEach((checkin, index) => {
                                if (checkin.today_checkin_id === this.currentCheckinRecordId || 
                                    (checkin.today_checkin_data && checkin.today_checkin_data.id === this.currentCheckinRecordId)) {
                                    
                                    // 清理计时器
                                    if (this.studyTimers && this.studyTimers[checkin.id]) {
                                        const timer = this.studyTimers[checkin.id];
                                        if (timer.interval) {
                                            clearInterval(timer.interval);
                                        }
                                        delete this.studyTimers[checkin.id];
                                    }
                                    
                                    // 创建一个新的checkin对象，确保没有studyTimer属性
                                    const cleanCheckin = { ...checkin };
                                    delete cleanCheckin.studyTimer;
                                    delete cleanCheckin.active_session;
                                    
                                    // 使用Vue.set更新数组元素
                                    this.$set(this.checkins, index, cleanCheckin);
                                    
                                    // 清理localStorage中的进度
                                    this.removeStudyProgress(checkin.id);
                                }
                            });
                        }
                        
                        this.currentCheckinRecordId = null;
                        
                        // 延迟刷新
                        setTimeout(() => {
                            this.refreshCheckins();
                        }, 100);
                    },
                    
                    sendOldEmailCode() {
                        if (!this.userInfo.email) {
                            this.$message.error('原邮箱为空，无法发送验证码');
                            return;
                        }
                        
                        axios.post('/accounts/send-verification-code/', {
                            email: this.userInfo.email
                        })
                        .then(response => {
                            this.$message.success('验证码已发送到原邮箱');
                            this.oldCodeSending = true;
                            this.oldCodeTimer = 60;
                            
                            // 倒计时
                            const timer = setInterval(() => {
                                this.oldCodeTimer -= 1;
                                if (this.oldCodeTimer <= 0) {
                                    clearInterval(timer);
                                    this.oldCodeSending = false;
                                }
                            }, 1000);
                        })
                        .catch(error => {
                            this.$message.error(error.response?.data?.error || '发送验证码失败');
                        });
                    },
                    sendNewEmailCode() {
                        if (!this.emailForm.newEmail) {
                            this.$message.error('新邮箱不能为空');
                            return;
                        }
                        
                        const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                        if (!emailRegex.test(this.emailForm.newEmail)) {
                            this.$message.error('请输入有效的邮箱地址');
                            return;
                        }
                        
                        axios.post('/accounts/send-verification-code/', {
                            email: this.emailForm.newEmail
                        })
                        .then(response => {
                            this.$message.success('验证码已发送到新邮箱');
                            this.newCodeSending = true;
                            this.newCodeTimer = 60;
                            
                            // 倒计时
                            const timer = setInterval(() => {
                                this.newCodeTimer -= 1;
                                if (this.newCodeTimer <= 0) {
                                    clearInterval(timer);
                                    this.newCodeSending = false;
                                }
                            }, 1000);
                        })
                        .catch(error => {
                            this.$message.error(error.response?.data?.error || '发送验证码失败');
                        });
                    },
                    updateEmail() {
                        // 验证表单
                        if (!this.emailForm.oldCode) {
                            this.$message.error('请输入原邮箱验证码');
                            return;
                        }
                        
                        if (!this.emailForm.newEmail) {
                            this.$message.error('请输入新邮箱');
                            return;
                        }
                        
                        if (!this.emailForm.newCode) {
                            this.$message.error('请输入新邮箱验证码');
                            return;
                        }
                        
                        const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                        if (!emailRegex.test(this.emailForm.newEmail)) {
                            this.$message.error('请输入有效的邮箱地址');
                            return;
                        }
                        
                        this.loading = true;
                        
                        axios.post('/accounts/update-email/', {
                            old_email: this.userInfo.email,
                            old_code: this.emailForm.oldCode,
                            new_email: this.emailForm.newEmail,
                            new_code: this.emailForm.newCode
                        })
                        .then(response => {
                            this.loading = false;
                            this.dialogVisible = false;
                            
                            // 更新用户信息
                            this.userInfo = response.data.user;
                            
                            // 更新本地存储
                            localStorage.setItem('user', JSON.stringify(this.userInfo));
                            
                            this.$message.success('邮箱更新成功');
                            
                            // 重置表单
                            this.emailForm = {
                                oldCode: '',
                                newEmail: '',
                                newCode: ''
                            };
                        })
                        .catch(error => {
                            this.loading = false;
                            this.$message.error(error.response?.data?.error || '更新邮箱失败');
                        });
                    },
                    viewPostDetail(post) {
                        // 跳转到帖子详情页
                        window.location.href = `/post_${post.id}.html`;
                    },
                    createPost() {
                        if (!this.newPost.title || !this.newPost.content) {
                            this.$message.error('帖子标题和内容不能为空');
                            return;
                        }
                        
                        // 确保选择了学校
                        if (!this.selectedSchool || !this.selectedSchool.id) {
                            this.$message.error('请先选择一个学校');
                            return;
                        }
                        
                        // 添加学校ID到请求数据
                        const postData = {
                            ...this.newPost,
                            school_id: this.selectedSchool.id
                        };
                        
                        this.loading = true;
                        axios.post('/forum/posts/create/', postData)
                            .then(response => {
                                this.dialogVisible = false;
                                
                                // 获取创建的帖子
                                const newPost = response.data.post || response.data;
                                
                                // 将新帖子添加到用户帖子列表
                                this.userPosts.unshift(newPost);
                                
                                this.$message.success('帖子发布成功，等待管理员审核');
                                
                                // 重置表单
                                this.newPost = {
                                    title: '',
                                    content: ''
                                };
                                
                                this.loading = false;
                            })
                            .catch(error => {
                                console.error('发布帖子失败:', error);
                                this.loading = false;
                                this.$message.error('发布帖子失败，请重试');
                            });
                    },
                    createPostDetailPage(post) {
                        // 发送请求创建帖子详情页面
                        axios.post('/forum/posts/generate-html/', { post_id: post.id })
                            .then(response => {
                                console.log('帖子详情页面已生成');
                            })
                            .catch(error => {
                                console.error('生成帖子详情页面失败:', error);
                            });
                    },
                    getStatusType(status) {
                        // 根据帖子状态返回相应的标签类型
                        switch (status) {
                            case 'pending':
                                return 'info';
                            case 'approved':
                                return 'success';
                            case 'rejected':
                                return 'danger';
                            default:
                                return 'info';
                        }
                    },
                    goToAdminPage() {
                        // 跳转到管理员页面
                        window.location.href = '/admin_center/admin/';
                    },
                    toggleDarkMode() {
                        // 实现夜间模式切换逻辑
                        console.log('夜间模式切换', this.settings.darkMode);
                        if (this.settings.darkMode) {
                            document.body.classList.add('dark-mode');
                            this.$message({
                                message: '已开启夜间模式',
                                type: 'success',
                                duration: 1500,
                                offset: 50
                            });
                        } else {
                            document.body.classList.remove('dark-mode');
                            this.$message({
                                message: '已关闭夜间模式',
                                type: 'info',
                                duration: 1500,
                                offset: 50
                            });
                        }
                        
                        // 保存设置到本地存储
                        this.saveSettings();
                    },
                    saveSettings() {
                        // 保存设置到本地存储
                        localStorage.setItem('settings', JSON.stringify(this.settings));
                    },
                    loadSettings() {
                        // 从本地存储加载设置
                        const savedSettings = localStorage.getItem('settings');
                        if (savedSettings) {
                            try {
                                const parsedSettings = JSON.parse(savedSettings);
                                this.settings = { ...this.settings, ...parsedSettings };
                                
                                // 应用夜间模式设置
                                if (this.settings.darkMode) {
                                    document.body.classList.add('dark-mode');
                                } else {
                                    document.body.classList.remove('dark-mode');
                                }
                            } catch (e) {
                                console.error('解析设置失败:', e);
                            }
                        }
                    },
                    fetchForumData(page = 1) {
                        if (!this.selectedSchool.id) return;
                        
                        // 如果是首次加载，显示主加载状态
                        if (page === 1) {
                            this.loading = true;
                        } else {
                            // 如果是分页加载，显示分页加载状态
                            this.paginationLoading = true;
                        }
                        
                        Promise.all([
                            axios.get(`/forum/posts/?school_id=${this.selectedSchool.id}&page=${page}&page_size=${this.pagination.pageSize}`),
                            axios.get('/forum/posts/user/') // 获取用户自己的帖子
                        ])
                        .then(([postsResponse, userPostsResponse]) => {
                            const responseData = postsResponse.data;
                            
                            // 处理新的API响应格式
                            if (responseData.posts) {
                                this.posts = responseData.posts;
                                this.pagination = {
                                    ...this.pagination,
                                    page: responseData.pagination.page,
                                    total: responseData.pagination.total,
                                    totalPages: responseData.pagination.total_pages,
                                    hasNext: responseData.pagination.has_next,
                                    hasPrev: responseData.pagination.has_prev
                                };
                            } else {
                                // 向后兼容旧格式
                                this.posts = responseData;
                            }
                            
                            this.userPosts = userPostsResponse.data;
                            
                            setTimeout(() => {
                                this.loading = false;
                                this.paginationLoading = false;
                            }, 200); // 添加短暂延迟，确保动画平滑
                        })
                        .catch(error => {
                            console.error('获取论坛数据失败:', error);
                            this.loading = false;
                            this.paginationLoading = false;
                            this.$message.error('获取论坛数据失败，请刷新页面重试');
                        });
                    },
                    enterChatRoom() {
                        // 根据选择的学校进入相应的聊天室
                        if (!this.selectedSchool || !this.selectedSchool.id) {
                            this.$message.error('请先选择一个学校');
                            return;
                        }
                        
                        // 跳转到对应学校的聊天室
                        window.location.href = `/chat/room/${this.selectedSchool.id}/`;
                    },
                    
                    // ===== 点赞和评论相关方法 =====
                    toggleLike(post) {
                        if (!this.isLoggedIn) {
                            this.$message.error('请先登录');
                            return;
                        }
                        
                        axios.post(`/forum/posts/${post.id}/like/`)
                            .then(response => {
                                if (response.data.success) {
                                    // 更新帖子的点赞状态
                                    post.user_liked = response.data.user_liked;
                                    post.likes_count = response.data.likes_count;
                                    
                                    this.$message({
                                        message: response.data.message,
                                        type: 'success',
                                        duration: 1500
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('点赞操作失败:', error);
                                this.$message.error('操作失败，请重试');
                            });
                    },
                    
                    showComments(post) {
                        this.currentPost = post;
                        this.commentsDialogVisible = true;
                        this.loadComments(post.id);
                    },
                    
                    loadComments(postId) {
                        this.commentsLoading = true;
                        axios.get(`/forum/posts/${postId}/comments/`)
                            .then(response => {
                                this.comments = response.data.comments || [];
                                this.commentsLoading = false;
                            })
                            .catch(error => {
                                console.error('加载评论失败:', error);
                                this.commentsLoading = false;
                                this.$message.error('加载评论失败');
                            });
                    },
                    
                    submitComment() {
                        if (!this.isLoggedIn) {
                            this.$message.error('请先登录');
                            return;
                        }
                        
                        if (!this.newComment.content.trim()) {
                            this.$message.error('评论内容不能为空');
                            return;
                        }
                        
                        const commentData = {
                            content: this.newComment.content,
                            parent_id: this.newComment.parent_id
                        };
                        
                        axios.post(`/forum/posts/${this.currentPost.id}/comments/create/`, commentData)
                            .then(response => {
                                if (response.data.success) {
                                    // 添加新评论到列表
                                    this.comments.unshift(response.data.comment);
                                    
                                    // 更新帖子的评论数量
                                    this.currentPost.comments_count = response.data.comments_count;
                                    
                                    // 重置评论表单
                                    this.newComment.content = '';
                                    this.newComment.parent_id = null;
                                    
                                    this.$message.success('评论发表成功');
                                }
                            })
                            .catch(error => {
                                console.error('发表评论失败:', error);
                                const errorMsg = error.response?.data?.error || '发表评论失败';
                                this.$message.error(errorMsg);
                            });
                    },
                    
                    replyToComment(comment) {
                        this.newComment.parent_id = comment.id;
                        // 可以在这里添加更多回复逻辑，比如在评论框中显示@用户名
                        this.$message.info(`回复 ${comment.username}`);
                    },
                    
                    deleteComment(comment) {
                        this.$confirm('确定要删除这条评论吗？', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            axios.delete(`/forum/comments/${comment.id}/delete/`)
                                .then(response => {
                                    if (response.data.success) {
                                        // 从列表中移除评论
                                        const index = this.comments.findIndex(c => c.id === comment.id);
                                        if (index !== -1) {
                                            this.comments.splice(index, 1);
                                        }
                                        
                                        // 更新帖子评论数量
                                        this.currentPost.comments_count = response.data.comments_count;
                                        
                                        this.$message.success('评论已删除');
                                    }
                                })
                                .catch(error => {
                                    console.error('删除评论失败:', error);
                                    this.$message.error('删除失败，请重试');
                                });
                        });
                    },
                    
                    // ===== 搜索相关方法 =====
                    handleSearchInput() {
                        // 防抖处理，500ms后执行搜索
                        if (this.searchInputTimer) {
                            clearTimeout(this.searchInputTimer);
                        }
                        
                        this.searchInputTimer = setTimeout(() => {
                            const query = this.search.query.trim();
                            if (query) {
                                this.performSearch(query);
                            } else {
                                this.clearSearch();
                            }
                        }, 500);
                    },
                    
                    performSearch(query, page = 1) {
                        if (!this.selectedSchool.id) {
                            this.$message.error('请先选择学校');
                            return;
                        }
                        
                        if (!query.trim()) {
                            this.clearSearch();
                            return;
                        }
                        
                        // 设置搜索状态
                        this.search.isSearchMode = true;
                        this.search.loading = true;
                        
                        // 保存搜索历史
                        this.saveSearchHistory(query);
                        
                        // 发送搜索请求
                        axios.get(`/forum/posts/search/?q=${encodeURIComponent(query)}&school_id=${this.selectedSchool.id}&page=${page}&page_size=${this.search.pagination.pageSize}`)
                            .then(response => {
                                const data = response.data;
                                
                                // 更新搜索结果
                                this.search.results = data.posts;
                                this.search.pagination = {
                                    page: data.pagination.page,
                                    pageSize: data.pagination.page_size,
                                    total: data.pagination.total,
                                    totalPages: data.pagination.total_pages,
                                    hasNext: data.pagination.has_next,
                                    hasPrev: data.pagination.has_prev
                                };
                                
                                // 更新搜索信息
                                this.search.totalFound = data.search_info.total_found;
                                this.search.searchTime = data.search_info.search_time;
                                
                                this.search.loading = false;
                                
                                // 如果是第一页，滚动到顶部
                                if (page === 1) {
                                    document.querySelector('.content-area').scrollTop = 0;
                                }
                                
                                // 显示搜索结果提示
                                if (data.search_info.total_found === 0) {
                                    this.$message.info('没有找到相关帖子');
                                } else {
                                    this.$message.success(`找到 ${data.search_info.total_found} 条相关帖子`);
                                }
                            })
                            .catch(error => {
                                console.error('搜索失败:', error);
                                this.search.loading = false;
                                this.$message.error('搜索失败，请重试');
                            });
                    },
                    
                    clearSearch() {
                        // 清空搜索状态
                        this.search.isSearchMode = false;
                        this.search.query = '';
                        this.search.results = [];
                        this.search.totalFound = 0;
                        this.search.searchTime = '';
                        this.search.pagination = {
                            page: 1,
                            pageSize: 10,
                            total: 0,
                            totalPages: 1,
                            hasNext: false,
                            hasPrev: false
                        };
                        
                        // 清除搜索防抖计时器
                        if (this.searchInputTimer) {
                            clearTimeout(this.searchInputTimer);
                            this.searchInputTimer = null;
                        }
                        
                        this.$message.info('已清空搜索');
                    },
                    
                    saveSearchHistory(query) {
                        // 保存搜索历史（最多保存10条）
                        const history = this.search.history.filter(h => h !== query);
                        history.unshift(query);
                        this.search.history = history.slice(0, 10);
                        
                        // 保存到本地存储
                        try {
                            localStorage.setItem('forum_search_history', JSON.stringify(this.search.history));
                        } catch (e) {
                            console.error('保存搜索历史失败:', e);
                        }
                    },
                    
                    loadSearchHistory() {
                        // 从本地存储加载搜索历史
                        try {
                            const history = localStorage.getItem('forum_search_history');
                            if (history) {
                                this.search.history = JSON.parse(history);
                            }
                        } catch (e) {
                            console.error('加载搜索历史失败:', e);
                        }
                    },
                    
                    useSearchHistory(query) {
                        // 使用搜索历史
                        this.search.query = query;
                        this.performSearch(query);
                    },
                    
                    highlightKeywords(text, keywords) {
                        // 高亮搜索关键词
                        if (!keywords || keywords.length === 0) {
                            return text;
                        }
                        
                        let highlightedText = text;
                        keywords.forEach(keyword => {
                            if (keyword.trim()) {
                                const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                                highlightedText = highlightedText.replace(regex, 
                                    '<span class="search-highlight">$1</span>');
                            }
                        });
                        return highlightedText;
                    },
                    
                    // 修改分页处理方法，支持搜索模式
                    handlePageChange(page) {
                        if (this.search.isSearchMode) {
                            this.performSearch(this.search.query, page);
                        } else {
                            this.fetchForumData(page);
                        }
                        // 滚动到页面顶部
                        document.querySelector('.content-area').scrollTop = 0;
                    },
                    
                    handlePageSizeChange(pageSize) {
                        if (this.search.isSearchMode) {
                            this.search.pagination.pageSize = pageSize;
                            this.search.pagination.page = 1;
                            this.performSearch(this.search.query, 1);
                        } else {
                            this.pagination.pageSize = pageSize;
                            this.pagination.page = 1;
                            this.fetchForumData(1);
                        }
                    },
                    handleCommunityPageChange(page) {
                        if (this.communityPagination.isSearchMode) {
                            this.performCommunitySearch(this.communitySearchQuery, page);
                        } else {
                            this.fetchCommunityData(page);
                        }
                        // 滚动到页面顶部
                        document.querySelector('.content-area').scrollTop = 0;
                    },
                    handleCommunityPageSizeChange(pageSize) {
                        if (this.communityPagination.isSearchMode) {
                            this.communityPagination.pageSize = pageSize;
                            this.communityPagination.page = 1;
                            this.performCommunitySearch(this.communitySearchQuery, 1);
                        } else {
                            this.communityPagination.pageSize = pageSize;
                            this.communityPagination.page = 1;
                            this.fetchCommunityData(1);
                        }
                    },
                    performCommunitySearch(query, page = 1) {
                        if (!this.selectedSchool.id) {
                            this.$message.error('请先选择学校');
                            return;
                        }
                        
                        if (!query.trim()) {
                            this.clearCommunitySearch();
                            return;
                        }
                        
                        // 设置搜索状态
                        this.communityPagination.isSearchMode = true;
                        this.communityLoading = true;
                        
                        // 保存搜索历史
                        this.saveCommunitySearchHistory(query);
                        
                        // 发送搜索请求
                        axios.get(`/forum/community/search/?q=${encodeURIComponent(query)}&school_id=${this.selectedSchool.id}&page=${page}&page_size=${this.communityPagination.pageSize}`)
                            .then(response => {
                                const data = response.data;
                                
                                // 更新搜索结果
                                this.communityCheckins = data.community_posts;
                                this.communityPagination = {
                                    ...this.communityPagination,
                                    page: data.pagination.page,
                                    total: data.pagination.total,
                                    totalPages: data.pagination.total_pages,
                                    hasNext: data.pagination.has_next,
                                    hasPrev: data.pagination.has_prev
                                };
                                
                                // 更新搜索信息
                                this.communitySearchInfo = data.search_info;
                                this.communityLoading = false;
                                
                                // 如果是第一页，滚动到顶部
                                if (page === 1) {
                                    document.querySelector('.content-area').scrollTop = 0;
                                }
                                
                                // 显示搜索结果提示
                                if (data.search_info.total_found === 0) {
                                    this.$message.info('没有找到相关帖子');
                                } else {
                                    this.$message.success(`找到 ${data.search_info.total_found} 条相关帖子`);
                                }
                            })
                            .catch(error => {
                                console.error('搜索失败:', error);
                                this.communityLoading = false;
                                this.$message.error('搜索失败，请重试');
                            });
                    },
                    clearCommunitySearch() {
                        // 清空搜索状态
                        this.communityPagination.isSearchMode = false;
                        this.communitySearchQuery = '';
                        this.communityCheckins = [];
                        this.communitySearchInfo = null;
                        this.communityPagination = {
                            page: 1,
                            pageSize: 10,
                            total: 0,
                            totalPages: 1,
                            hasNext: false,
                            hasPrev: false
                        };
                        
                        // 清除搜索防抖计时器
                        if (this.communitySearchInputTimer) {
                            clearTimeout(this.communitySearchInputTimer);
                            this.communitySearchInputTimer = null;
                        }
                        
                        this.$message.info('已清空搜索');
                    },
                    saveCommunitySearchHistory(query) {
                        // 保存搜索历史（最多保存10条）
                        const history = this.communitySearchHistory.filter(h => h !== query);
                        history.unshift(query);
                        this.communitySearchHistory = history.slice(0, 10);
                        
                        // 保存到本地存储
                        try {
                            localStorage.setItem('forum_community_search_history', JSON.stringify(this.communitySearchHistory));
                        } catch (e) {
                            console.error('保存搜索历史失败:', e);
                        }
                    },
                    loadCommunitySearchHistory() {
                        // 从本地存储加载搜索历史
                        try {
                            const history = localStorage.getItem('forum_community_search_history');
                            if (history) {
                                this.communitySearchHistory = JSON.parse(history);
                            }
                        } catch (e) {
                            console.error('加载搜索历史失败:', e);
                        }
                    },
                    useCommunitySearchHistory(query) {
                        // 使用搜索历史
                        this.communitySearchQuery = query;
                        this.performCommunitySearch(query);
                    },
                    fetchUserPosts(page = 1) {
                        this.userPostsLoading = true;
                        axios.get(`/forum/posts/user/?page=${page}&page_size=${this.userPostsPagination.pageSize}`)
                            .then(response => {
                                this.userPosts = response.data.posts || [];
                                this.userPostsPagination = {
                                    ...this.userPostsPagination,
                                    page: response.data.pagination.page,
                                    total: response.data.pagination.total,
                                    totalPages: response.data.pagination.total_pages,
                                    hasNext: response.data.pagination.has_next,
                                    hasPrev: response.data.pagination.has_prev
                                };
                                this.userPostsLoading = false;
                            })
                            .catch(error => {
                                console.error('获取用户帖子失败:', error);
                                this.userPostsLoading = false;
                                this.$message.error('获取用户帖子失败，请重试');
                            });
                    },
                    
                    refreshUserPosts() {
                        this.fetchUserPosts(1);
                        this.$message.success('正在刷新我的帖子');
                    },
                    handleUserPostsPageChange(page) {
                        this.fetchUserPosts(page);
                        // 滚动到页面顶部
                        document.querySelector('.content-area').scrollTop = 0;
                    },
                    handleUserPostsPageSizeChange(pageSize) {
                        this.userPostsPagination.pageSize = pageSize;
                        this.userPostsPagination.page = 1;
                        this.fetchUserPosts(1);
                    }
                },
                beforeDestroy() {
                    // 清理计时器代码已删除
                },
                mounted() {
                    console.log("Vue实例已挂载");
                    // 检查登录状态
                    this.checkLoginStatus();
                    
                    // 恢复tab状态（如果是从详情页返回）
                    this.restoreTabState();
                    
                    // 加载用户设置
                    this.loadSettings();
                    
                    // 加载用户数据
                    this.loading = true;
                    this.loadUserData();
                    
                    // 专注模式数据加载已删除
                    
                    // 获取学校列表
                    this.fetchSchools();
                    
                    // 加载搜索历史
                    this.loadSearchHistory();
                    
                    // 恢复学习进度（延迟执行，确保数据加载完成）
                    setTimeout(() => {
                        this.restoreAllStudyProgress();
                    }, 1000);
                    
                    // 如果当前标签是动态，加载社区数据
                    if (this.currentTab === 'tasks') {
                        this.fetchCommunityData(1);
                    }
                    
                    // 如果用户已登录，加载用户帖子
                    if (this.isLoggedIn && this.currentTab === 'forum') {
                        this.fetchUserPosts(1);
                    }
                    
                    // 隐藏静态内容
                    let staticContent = document.getElementById('static-content');
                    if (staticContent) {
                        staticContent.style.display = 'none';
                    }
                    
                    // 标记初始化完成
                    this.initialized = true;
                }
            });
        });
        
        // 立即确保app显示
        window.onload = function() {
            var appElement = document.getElementById('app');
            if (appElement) {
                // 不在这里设置display:block，而是依赖v-cloak指令和Vue初始化后自动显示
            }
            
            setTimeout(function() {
                var staticContent = document.getElementById('static-content');
                if (staticContent) {
                    staticContent.style.display = 'none';
                }
            }, 500);
        };
    </script>
</body>
</html> 